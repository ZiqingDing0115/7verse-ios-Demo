<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¤– Model Arena - Qwen vs Gemini å¯¹æ¯”</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b4e 100%);
      min-height: 100vh;
    }
    .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
    .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
    .glow-purple { box-shadow: 0 0 20px rgba(168, 85, 247, 0.3); }
    textarea, input { background: rgba(0,0,0,0.3); }
    .streaming { animation: blink 0.5s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .typing::after { content: 'â–‹'; animation: cursor 1s infinite; }
    @keyframes cursor { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
  </style>
</head>
<body class="text-white p-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold mb-2">ğŸ¤– Model Arena</h1>
      <p class="text-gray-400">Qwen 235B vs Gemini 3 Flash | é€Ÿåº¦ & è´¨é‡å¯¹æ¯”</p>
    </div>

    <!-- ä»»åŠ¡é€‰æ‹© -->
    <div class="card rounded-xl p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">ğŸ“‹ é€‰æ‹©æµ‹è¯•ä»»åŠ¡</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <button onclick="selectTask('tags')" class="task-btn bg-gray-800 hover:bg-indigo-600 p-4 rounded-lg text-center transition" data-task="tags">
          <div class="text-2xl mb-1">ğŸ·ï¸</div>
          <div class="text-sm">æ ‡ç­¾æ¨è</div>
        </button>
        <button onclick="selectTask('voice')" class="task-btn bg-gray-800 hover:bg-indigo-600 p-4 rounded-lg text-center transition" data-task="voice">
          <div class="text-2xl mb-1">ğŸ™ï¸</div>
          <div class="text-sm">éŸ³è‰²æ¨è</div>
        </button>
        <button onclick="selectTask('image')" class="task-btn bg-gray-800 hover:bg-indigo-600 p-4 rounded-lg text-center transition" data-task="image">
          <div class="text-2xl mb-1">ğŸ¨</div>
          <div class="text-sm">å›¾ç”Ÿå›¾ Prompt</div>
        </button>
        <button onclick="selectTask('video')" class="task-btn bg-gray-800 hover:bg-indigo-600 p-4 rounded-lg text-center transition" data-task="video">
          <div class="text-2xl mb-1">ğŸ¬</div>
          <div class="text-sm">è§†é¢‘ Prompt</div>
        </button>
      </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="card rounded-xl p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">ğŸ“ è¾“å…¥ Prompt</h2>
      <div class="mb-4">
        <label class="text-sm text-gray-400 mb-2 block">System Prompt:</label>
        <textarea id="systemPrompt" rows="3" 
                  class="w-full rounded-lg p-3 text-sm resize-none border border-gray-700 focus:border-indigo-500"
                  placeholder="ç³»ç»Ÿæç¤ºè¯..."></textarea>
      </div>
      <div class="mb-4">
        <label class="text-sm text-gray-400 mb-2 block">User Prompt:</label>
        <textarea id="userPrompt" rows="4" 
                  class="w-full rounded-lg p-3 text-sm resize-none border border-gray-700 focus:border-indigo-500"
                  placeholder="ç”¨æˆ·è¾“å…¥..."></textarea>
      </div>
      <div class="flex gap-4 items-center">
        <div class="flex-1">
          <label class="text-sm text-gray-400">Max Tokens:</label>
          <input type="number" id="maxTokens" value="500" class="w-24 rounded px-3 py-1 ml-2">
        </div>
        <div class="flex-1">
          <label class="text-sm text-gray-400">Temperature:</label>
          <input type="number" id="temperature" value="0.7" step="0.1" min="0" max="2" class="w-24 rounded px-3 py-1 ml-2">
        </div>
        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" id="enableStreaming" checked class="rounded">
          <span>Qwen æµå¼è¾“å‡º</span>
        </label>
      </div>
    </div>

    <!-- å¼€å§‹æŒ‰é’® -->
    <div class="text-center mb-6">
      <button onclick="runBattle()" 
              class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 
                     px-12 py-4 rounded-xl font-bold text-xl transition transform hover:scale-105">
        âš”ï¸ å¼€å§‹ Battleï¼
      </button>
    </div>

    <!-- å¯¹æ¯”ç»“æœ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Qwen -->
      <div class="card rounded-xl p-6 glow-blue">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-blue-400">ğŸ§  Qwen 235B</h3>
          <div class="flex items-center gap-2">
            <span id="qwenStatus" class="text-xs bg-gray-700 px-2 py-1 rounded">å¾…å‘½</span>
            <span id="qwenTime" class="text-sm text-gray-400">-</span>
          </div>
        </div>
        <div id="qwenOutput" class="bg-gray-900 rounded-lg p-4 min-h-[200px] font-mono text-sm overflow-y-auto max-h-[400px]">
          <span class="text-gray-500">// Qwen å“åº”å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</span>
        </div>
        <div class="mt-4 flex justify-between text-xs text-gray-500">
          <span>é¦– Token: <span id="qwenTTFT" class="text-blue-400">-</span></span>
          <span>æ€» Token: <span id="qwenTokens" class="text-blue-400">-</span></span>
          <span>TPS: <span id="qwenTPS" class="text-blue-400">-</span></span>
        </div>
      </div>

      <!-- Gemini -->
      <div class="card rounded-xl p-6 glow-purple">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-purple-400">âœ¨ Gemini 3 Flash</h3>
          <div class="flex items-center gap-2">
            <span id="geminiStatus" class="text-xs bg-gray-700 px-2 py-1 rounded">å¾…å‘½</span>
            <span id="geminiTime" class="text-sm text-gray-400">-</span>
          </div>
        </div>
        <div id="geminiOutput" class="bg-gray-900 rounded-lg p-4 min-h-[200px] font-mono text-sm overflow-y-auto max-h-[400px]">
          <span class="text-gray-500">// Gemini å“åº”å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</span>
        </div>
        <div class="mt-4 flex justify-between text-xs text-gray-500">
          <span>é¦– Token: <span id="geminiTTFT" class="text-purple-400">-</span></span>
          <span>æ€»è€—æ—¶: <span id="geminiTotal" class="text-purple-400">-</span></span>
          <span>çŠ¶æ€: <span id="geminiResult" class="text-purple-400">-</span></span>
        </div>
      </div>
    </div>

    <!-- è¯„åˆ† & Insights -->
    <div class="card rounded-xl p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">ğŸ“Š è¯„åˆ† & è®°å½•</h2>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div>
          <label class="text-sm text-gray-400">Qwen è¯„åˆ† (1-10):</label>
          <input type="number" id="qwenScore" min="1" max="10" class="w-full rounded px-3 py-2 mt-1">
        </div>
        <div>
          <label class="text-sm text-gray-400">Gemini è¯„åˆ† (1-10):</label>
          <input type="number" id="geminiScore" min="1" max="10" class="w-full rounded px-3 py-2 mt-1">
        </div>
      </div>
      <div class="mb-4">
        <label class="text-sm text-gray-400">Insights / å¤‡æ³¨:</label>
        <textarea id="insights" rows="3" 
                  class="w-full rounded-lg p-3 text-sm resize-none border border-gray-700 focus:border-indigo-500 mt-1"
                  placeholder="è®°å½•è§‚å¯Ÿåˆ°çš„å·®å¼‚ã€ä¼˜ç¼ºç‚¹..."></textarea>
      </div>
      <div class="flex gap-4">
        <button onclick="saveResult()" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg transition">
          ğŸ’¾ ä¿å­˜ç»“æœ
        </button>
        <button onclick="exportResults()" class="bg-gray-700 hover:bg-gray-600 px-6 py-2 rounded-lg transition">
          ğŸ“¤ å¯¼å‡ºæŠ¥å‘Š
        </button>
      </div>
    </div>

    <!-- å†å²è®°å½• -->
    <div class="card rounded-xl p-6">
      <h2 class="text-xl font-semibold mb-4">ğŸ“œ æµ‹è¯•å†å²</h2>
      <div id="history" class="space-y-2 max-h-64 overflow-y-auto">
        <p class="text-gray-500 text-sm">æš‚æ— è®°å½•...</p>
      </div>
    </div>
  </div>

  <script>
    let currentTask = 'tags';
    let testHistory = [];

    // é¢„è®¾ä»»åŠ¡
    const TASK_PROMPTS = {
      tags: {
        system: `You are an Expert Visual Style Analyst. Analyze the image and recommend 7 tags from: CEO, Doctor, Artist, Student, Idol, Mafia-Boss, Dark-Academia, Cyberpunk, Gothic, Anime, Vampire, Demon, Angel, Prince, Knight.

Output JSON: {"recommended_tags": ["tag1", "tag2", ...]}`,
        user: 'Analyze this portrait and recommend suitable persona tags.'
      },
      voice: {
        system: `You are an Audio Casting Director. Recommend the best voice for a character.
Voice options: Sweet Girl, Mature Lady, Fierce Queen, Alpha Male, Dark Lord, Gentle Giant, Robot Butler, Mischievous Imp.

Output JSON: {"recommended_voice": "voice_name", "reasoning": "why"}`,
        user: 'Based on a mysterious vampire character with dark academia style, recommend a voice.'
      },
      image: {
        system: `You are a creative director generating 3 CINEMATIC character portraits.
Start with: "exact same person exact same face"
End with: "preserve facial features"
Use different camera angles and scenes.

Output JSON: {"prompts": ["prompt1", "prompt2", "prompt3"], "styleLabels": ["label1", "label2", "label3"]}`,
        user: 'Character tags: Vampire, Gothic, Prince\nGenerate 3 cinematic scene prompts.'
      },
      video: {
        system: `Generate a short video prompt for Image-to-Video generation.
The prompt should describe natural character movement (smile, wave, turn head).
Keep it under 20 words.

Output JSON: {"video_prompt": "description of movement"}`,
        user: 'Generate a video prompt for a prince character looking mysteriously at the camera.'
      }
    };

    function selectTask(task) {
      currentTask = task;
      document.querySelectorAll('.task-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-600');
        btn.classList.add('bg-gray-800');
      });
      document.querySelector(`[data-task="${task}"]`).classList.remove('bg-gray-800');
      document.querySelector(`[data-task="${task}"]`).classList.add('bg-indigo-600');
      
      const prompts = TASK_PROMPTS[task];
      document.getElementById('systemPrompt').value = prompts.system;
      document.getElementById('userPrompt').value = prompts.user;
    }

    // è¿è¡Œ Battle
    async function runBattle() {
      const systemPrompt = document.getElementById('systemPrompt').value;
      const userPrompt = document.getElementById('userPrompt').value;
      const maxTokens = parseInt(document.getElementById('maxTokens').value);
      const temperature = parseFloat(document.getElementById('temperature').value);
      const enableStreaming = document.getElementById('enableStreaming').checked;
      
      // é‡ç½® UI
      resetUI();
      
      // å¹¶è¡Œè°ƒç”¨ä¸¤ä¸ªæ¨¡å‹
      const qwenPromise = callQwen(systemPrompt, userPrompt, maxTokens, temperature, enableStreaming);
      const geminiPromise = callGemini(systemPrompt, userPrompt, maxTokens, temperature);
      
      await Promise.all([qwenPromise, geminiPromise]);
    }

    // Qwen API (æµå¼)
    async function callQwen(systemPrompt, userPrompt, maxTokens, temperature, streaming) {
      const output = document.getElementById('qwenOutput');
      const status = document.getElementById('qwenStatus');
      const timeEl = document.getElementById('qwenTime');
      const ttftEl = document.getElementById('qwenTTFT');
      const tokensEl = document.getElementById('qwenTokens');
      const tpsEl = document.getElementById('qwenTPS');
      
      output.innerHTML = '';
      status.textContent = 'ğŸ”„ è¯·æ±‚ä¸­...';
      status.className = 'text-xs bg-yellow-600 px-2 py-1 rounded streaming';
      
      const startTime = performance.now();
      let firstTokenTime = null;
      let tokenCount = 0;
      
      try {
        const response = await fetch('/api/qwen/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'qwen-plus',
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: userPrompt }
            ],
            max_tokens: maxTokens,
            temperature: temperature,
            stream: streaming
          })
        });
        
        if (streaming) {
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop() || '';
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (data === '[DONE]') continue;
                
                try {
                  const json = JSON.parse(data);
                  const content = json.choices?.[0]?.delta?.content || '';
                  if (content) {
                    if (!firstTokenTime) {
                      firstTokenTime = performance.now();
                      const ttft = ((firstTokenTime - startTime) / 1000).toFixed(3);
                      ttftEl.textContent = `${ttft}s`;
                      status.textContent = 'âš¡ æµå¼è¾“å‡ºä¸­...';
                    }
                    output.innerHTML += content;
                    tokenCount++;
                    output.scrollTop = output.scrollHeight;
                  }
                } catch (e) {}
              }
            }
          }
        } else {
          const data = await response.json();
          output.innerHTML = data.choices?.[0]?.message?.content || 'No response';
          firstTokenTime = performance.now();
        }
        
        const endTime = performance.now();
        const totalTime = ((endTime - startTime) / 1000).toFixed(2);
        const tps = tokenCount > 0 ? (tokenCount / (endTime - (firstTokenTime || startTime)) * 1000).toFixed(1) : '-';
        
        timeEl.textContent = `${totalTime}s`;
        tokensEl.textContent = tokenCount > 0 ? tokenCount : '~';
        tpsEl.textContent = tps;
        status.textContent = 'âœ… å®Œæˆ';
        status.className = 'text-xs bg-green-600 px-2 py-1 rounded';
        
      } catch (error) {
        const endTime = performance.now();
        const totalTime = ((endTime - startTime) / 1000).toFixed(2);
        
        output.innerHTML = `<span class="text-red-400">Error: ${error.message}</span>`;
        timeEl.textContent = `${totalTime}s`;
        status.textContent = 'âŒ å¤±è´¥';
        status.className = 'text-xs bg-red-600 px-2 py-1 rounded';
      }
    }

    // Gemini API
    async function callGemini(systemPrompt, userPrompt, maxTokens, temperature) {
      const output = document.getElementById('geminiOutput');
      const status = document.getElementById('geminiStatus');
      const timeEl = document.getElementById('geminiTime');
      const ttftEl = document.getElementById('geminiTTFT');
      const totalEl = document.getElementById('geminiTotal');
      const resultEl = document.getElementById('geminiResult');
      
      output.innerHTML = '<span class="text-gray-400 typing">Thinking</span>';
      status.textContent = 'ğŸ”„ è¯·æ±‚ä¸­...';
      status.className = 'text-xs bg-yellow-600 px-2 py-1 rounded';
      
      const startTime = performance.now();
      
      try {
        // ä½¿ç”¨ä½ çš„ Gemini API key
        const apiKey = 'AIzaSyBIEPo2i5dNwg7ujMWxkNICs7P-O5W00os';
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{
              parts: [{ text: systemPrompt + '\n\n' + userPrompt }]
            }],
            generationConfig: {
              maxOutputTokens: maxTokens,
              temperature: temperature
            }
          })
        });
        
        const firstTokenTime = performance.now();
        const ttft = ((firstTokenTime - startTime) / 1000).toFixed(3);
        ttftEl.textContent = `${ttft}s`;
        
        const data = await response.json();
        const endTime = performance.now();
        const totalTime = ((endTime - startTime) / 1000).toFixed(2);
        
        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
          output.innerHTML = data.candidates[0].content.parts[0].text;
          timeEl.textContent = `${totalTime}s`;
          totalEl.textContent = `${totalTime}s`;
          resultEl.textContent = 'OK';
          status.textContent = 'âœ… å®Œæˆ';
          status.className = 'text-xs bg-green-600 px-2 py-1 rounded';
        } else {
          throw new Error('No response content');
        }
        
      } catch (error) {
        const endTime = performance.now();
        const totalTime = ((endTime - startTime) / 1000).toFixed(2);
        
        output.innerHTML = `<span class="text-red-400">Error: ${error.message}</span>`;
        timeEl.textContent = `${totalTime}s`;
        status.textContent = 'âŒ å¤±è´¥';
        status.className = 'text-xs bg-red-600 px-2 py-1 rounded';
      }
    }

    function resetUI() {
      ['qwen', 'gemini'].forEach(model => {
        document.getElementById(`${model}Output`).innerHTML = `<span class="text-gray-500">// ç­‰å¾…å“åº”...</span>`;
        document.getElementById(`${model}Status`).textContent = 'å¾…å‘½';
        document.getElementById(`${model}Status`).className = 'text-xs bg-gray-700 px-2 py-1 rounded';
        document.getElementById(`${model}Time`).textContent = '-';
      });
      document.getElementById('qwenTTFT').textContent = '-';
      document.getElementById('qwenTokens').textContent = '-';
      document.getElementById('qwenTPS').textContent = '-';
      document.getElementById('geminiTTFT').textContent = '-';
      document.getElementById('geminiTotal').textContent = '-';
      document.getElementById('geminiResult').textContent = '-';
    }

    // ä¿å­˜ç»“æœ
    function saveResult() {
      const result = {
        id: Date.now(),
        task: currentTask,
        timestamp: new Date().toLocaleString(),
        qwenTime: document.getElementById('qwenTime').textContent,
        geminiTime: document.getElementById('geminiTime').textContent,
        qwenScore: document.getElementById('qwenScore').value || '-',
        geminiScore: document.getElementById('geminiScore').value || '-',
        insights: document.getElementById('insights').value || '-',
        winner: determineWinner()
      };
      
      testHistory.unshift(result);
      updateHistory();
      
      // æ¸…ç©ºè¯„åˆ†
      document.getElementById('qwenScore').value = '';
      document.getElementById('geminiScore').value = '';
      document.getElementById('insights').value = '';
      
      alert('âœ… ç»“æœå·²ä¿å­˜ï¼');
    }

    function determineWinner() {
      const qScore = parseInt(document.getElementById('qwenScore').value) || 0;
      const gScore = parseInt(document.getElementById('geminiScore').value) || 0;
      if (qScore > gScore) return 'Qwen';
      if (gScore > qScore) return 'Gemini';
      return 'Tie';
    }

    function updateHistory() {
      const container = document.getElementById('history');
      if (testHistory.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">æš‚æ— è®°å½•...</p>';
        return;
      }
      
      container.innerHTML = testHistory.map(r => `
        <div class="bg-gray-800 rounded p-3 text-sm">
          <div class="flex justify-between items-center mb-1">
            <span class="text-gray-400">${r.timestamp} | ${r.task}</span>
            <span class="${r.winner === 'Qwen' ? 'text-blue-400' : r.winner === 'Gemini' ? 'text-purple-400' : 'text-gray-400'}">
              ğŸ† ${r.winner}
            </span>
          </div>
          <div class="flex gap-4 text-xs">
            <span>Qwen: ${r.qwenTime} (${r.qwenScore}åˆ†)</span>
            <span>Gemini: ${r.geminiTime} (${r.geminiScore}åˆ†)</span>
          </div>
          ${r.insights !== '-' ? `<p class="text-gray-500 text-xs mt-1">${r.insights}</p>` : ''}
        </div>
      `).join('');
    }

    // å¯¼å‡ºæŠ¥å‘Š
    function exportResults() {
      let report = `# Model Arena æµ‹è¯•æŠ¥å‘Š\n\n`;
      report += `ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\n\n`;
      report += `## æµ‹è¯•ç»Ÿè®¡\n\n`;
      
      const qwenWins = testHistory.filter(r => r.winner === 'Qwen').length;
      const geminiWins = testHistory.filter(r => r.winner === 'Gemini').length;
      const ties = testHistory.filter(r => r.winner === 'Tie').length;
      
      report += `- æ€»æµ‹è¯•æ¬¡æ•°: ${testHistory.length}\n`;
      report += `- Qwen èƒœ: ${qwenWins}\n`;
      report += `- Gemini èƒœ: ${geminiWins}\n`;
      report += `- å¹³å±€: ${ties}\n\n`;
      
      report += `## è¯¦ç»†è®°å½•\n\n`;
      testHistory.forEach((r, i) => {
        report += `### Test ${i + 1} (${r.task})\n`;
        report += `- æ—¶é—´: ${r.timestamp}\n`;
        report += `- Qwen: ${r.qwenTime}, è¯„åˆ† ${r.qwenScore}\n`;
        report += `- Gemini: ${r.geminiTime}, è¯„åˆ† ${r.geminiScore}\n`;
        report += `- èƒœè€…: ${r.winner}\n`;
        if (r.insights !== '-') report += `- Insights: ${r.insights}\n`;
        report += `\n`;
      });
      
      const blob = new Blob([report], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `model-arena-report-${Date.now()}.md`;
      a.click();
    }

    // åˆå§‹åŒ–
    selectTask('tags');
  </script>
</body>
</html>
