<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ¨ Prompt Arena - å›¾ç”Ÿå›¾ Prompt æµ‹è¯•</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
    }
    .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
    .glow { box-shadow: 0 0 20px rgba(99, 102, 241, 0.3); }
    textarea { background: rgba(0,0,0,0.3); }
    .loading { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body class="text-white p-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold mb-2">ğŸ¨ Prompt Arena</h1>
      <p class="text-gray-400">æµ‹è¯•ä¸åŒ Prompt å¯¹å›¾ç”Ÿå›¾æ•ˆæœçš„å½±å“ | v0.6 åœºæ™¯åŒ–ç‰ˆ</p>
    </div>

    <!-- ä¸Šä¼ åŒºåŸŸ -->
    <div class="card rounded-xl p-6 mb-6 glow">
      <h2 class="text-xl font-semibold mb-4">ğŸ“· ä¸Šä¼ æµ‹è¯•å›¾ç‰‡</h2>
      <div class="flex gap-4 items-center">
        <input type="file" id="imageInput" accept="image/*" class="hidden">
        <button onclick="document.getElementById('imageInput').click()" 
                class="bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded-lg font-medium transition">
          é€‰æ‹©å›¾ç‰‡
        </button>
        <div id="imagePreview" class="w-32 h-32 bg-gray-800 rounded-lg flex items-center justify-center text-gray-500">
          æ— å›¾ç‰‡
        </div>
        <div class="flex-1">
          <p class="text-sm text-gray-400 mb-2">æˆ–ä½¿ç”¨æµ‹è¯•å›¾ç‰‡ URL:</p>
          <input type="text" id="imageUrl" placeholder="https://..." 
                 class="w-full bg-gray-800 rounded px-4 py-2 text-sm">
        </div>
      </div>
    </div>

    <!-- æ ‡ç­¾é€‰æ‹© -->
    <div class="card rounded-xl p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">ğŸ·ï¸ é€‰æ‹©è§’è‰²æ ‡ç­¾ï¼ˆç”¨äº AI ç”Ÿæˆ Promptï¼‰</h2>
      <div id="tagContainer" class="flex flex-wrap gap-2 mb-4">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
      <p class="text-sm text-gray-400">å·²é€‰æ‹©: <span id="selectedTagsDisplay" class="text-indigo-400">æ— </span></p>
    </div>

    <!-- Prompt å¯¹æ¯”åŒº -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <!-- Prompt A -->
      <div class="card rounded-xl p-4">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-semibold text-indigo-400">Prompt A</h3>
          <span class="text-xs bg-gray-700 px-2 py-1 rounded">æ‰‹åŠ¨</span>
        </div>
        <textarea id="promptA" rows="5" 
                  class="w-full rounded-lg p-3 text-sm resize-none border border-gray-700 focus:border-indigo-500"
                  placeholder="è¾“å…¥ä½ çš„ Prompt...">exact same person exact same face, dark throne room, low angle shot, dramatic candlelight, preserve facial features</textarea>
      </div>

      <!-- Prompt B -->
      <div class="card rounded-xl p-4">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-semibold text-green-400">Prompt B</h3>
          <span class="text-xs bg-gray-700 px-2 py-1 rounded">æ‰‹åŠ¨</span>
        </div>
        <textarea id="promptB" rows="5" 
                  class="w-full rounded-lg p-3 text-sm resize-none border border-gray-700 focus:border-green-500"
                  placeholder="è¾“å…¥ä½ çš„ Prompt...">exact same person exact same face, cyberpunk neon city, profile view, blue and pink neon lights, preserve facial features</textarea>
      </div>

      <!-- Prompt C (AI ç”Ÿæˆ) -->
      <div class="card rounded-xl p-4">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-semibold text-purple-400">Prompt C</h3>
          <span class="text-xs bg-purple-900 px-2 py-1 rounded">ğŸ¤– AI ç”Ÿæˆ</span>
        </div>
        <textarea id="promptC" rows="5" 
                  class="w-full rounded-lg p-3 text-sm resize-none border border-gray-700 focus:border-purple-500"
                  placeholder="ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è®© AI æ ¹æ®æ ‡ç­¾ç”Ÿæˆ..."></textarea>
        <button onclick="generateAIPrompt()" 
                class="mt-2 w-full bg-purple-600 hover:bg-purple-700 py-2 rounded text-sm transition">
          ğŸ¤– æ ¹æ®æ ‡ç­¾ç”Ÿæˆ Prompt
        </button>
      </div>
    </div>

    <!-- ç”ŸæˆæŒ‰é’® -->
    <div class="text-center mb-6">
      <button onclick="runComparison()" 
              class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 
                     px-12 py-4 rounded-xl font-bold text-xl transition transform hover:scale-105 glow">
        ğŸš€ å¼€å§‹å¯¹æ¯”ç”Ÿæˆ
      </button>
    </div>

    <!-- ç»“æœå¯¹æ¯” -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="card rounded-xl p-4">
        <h3 class="font-semibold text-indigo-400 mb-2">ç»“æœ A</h3>
        <div id="resultA" class="aspect-square bg-gray-800 rounded-lg flex items-center justify-center text-gray-500">
          ç­‰å¾…ç”Ÿæˆ...
        </div>
        <p id="timeA" class="text-xs text-gray-400 mt-2 text-center">-</p>
      </div>
      <div class="card rounded-xl p-4">
        <h3 class="font-semibold text-green-400 mb-2">ç»“æœ B</h3>
        <div id="resultB" class="aspect-square bg-gray-800 rounded-lg flex items-center justify-center text-gray-500">
          ç­‰å¾…ç”Ÿæˆ...
        </div>
        <p id="timeB" class="text-xs text-gray-400 mt-2 text-center">-</p>
      </div>
      <div class="card rounded-xl p-4">
        <h3 class="font-semibold text-purple-400 mb-2">ç»“æœ C (AI)</h3>
        <div id="resultC" class="aspect-square bg-gray-800 rounded-lg flex items-center justify-center text-gray-500">
          ç­‰å¾…ç”Ÿæˆ...
        </div>
        <p id="timeC" class="text-xs text-gray-400 mt-2 text-center">-</p>
      </div>
    </div>

    <!-- æµ‹è¯•è®°å½• -->
    <div class="card rounded-xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold">ğŸ“ æµ‹è¯•è®°å½• & Insights</h2>
        <button onclick="exportInsights()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded text-sm">
          ğŸ“¤ å¯¼å‡ºåˆ° Prompt Guide
        </button>
      </div>
      <div id="testLog" class="bg-gray-900 rounded-lg p-4 font-mono text-sm max-h-64 overflow-y-auto">
        <p class="text-gray-500">// æµ‹è¯•è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
      </div>
    </div>
  </div>

  <script>
    // æ ‡ç­¾åº“
    const TAGS = [
      // Roleplay
      'Vampire', 'Demon', 'Angel', 'Prince', 'Knight', 'Assassin', 'Mage', 'Witch', 'Dragon',
      // Style
      'Cyberpunk', 'Gothic', 'Dark-Academia', 'Anime', 'Film-Noir', 'Fantasy', 'Steampunk', 'Vaporwave',
      // Identity
      'CEO', 'Mafia-Boss', 'Detective', 'Soldier', 'Idol', 'Artist'
    ];
    
    let selectedTags = [];
    let uploadedImageBase64 = null;

    // åˆå§‹åŒ–æ ‡ç­¾
    function initTags() {
      const container = document.getElementById('tagContainer');
      TAGS.forEach(tag => {
        const btn = document.createElement('button');
        btn.className = 'px-3 py-1 rounded-full text-sm border border-gray-600 hover:border-indigo-400 transition';
        btn.textContent = tag;
        btn.onclick = () => toggleTag(tag, btn);
        container.appendChild(btn);
      });
    }

    function toggleTag(tag, btn) {
      if (selectedTags.includes(tag)) {
        selectedTags = selectedTags.filter(t => t !== tag);
        btn.classList.remove('bg-indigo-600', 'border-indigo-600');
      } else {
        selectedTags.push(tag);
        btn.classList.add('bg-indigo-600', 'border-indigo-600');
      }
      document.getElementById('selectedTagsDisplay').textContent = selectedTags.join(', ') || 'æ— ';
    }

    // å›¾ç‰‡ä¸Šä¼ 
    document.getElementById('imageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadedImageBase64 = e.target.result;
          document.getElementById('imagePreview').innerHTML = 
            `<img src="${uploadedImageBase64}" class="w-full h-full object-cover rounded-lg">`;
        };
        reader.readAsDataURL(file);
      }
    });

    // AI ç”Ÿæˆ Prompt
    async function generateAIPrompt() {
      if (selectedTags.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€äº›æ ‡ç­¾ï¼');
        return;
      }
      
      const textarea = document.getElementById('promptC');
      textarea.value = 'â³ AI æ­£åœ¨ç”Ÿæˆ...';
      
      const systemPrompt = `You are a creative director. Generate 1 SHORT cinematic prompt (under 20 words).
Format: "exact same person exact same face, [scene], [angle], [lighting], preserve facial features"
Based on tags: ${selectedTags.join(', ')}`;
      
      try {
        // è¿™é‡Œå¯ä»¥è°ƒç”¨ Gemini API
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: systemPrompt,
            maxTokens: 100
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          textarea.value = data.text || 'AI ç”Ÿæˆå¤±è´¥';
        } else {
          // æœ¬åœ°æ¨¡æ‹Ÿ
          const scenes = {
            'Vampire': 'gothic castle, candlelit chamber, dramatic shadows',
            'Prince': 'throne room, royal lighting, majestic atmosphere',
            'Cyberpunk': 'neon city street, holographic displays, rain reflections',
            'Demon': 'hellfire background, volcanic lair, intense red glow',
            'Angel': 'heavenly clouds, golden light rays, ethereal glow'
          };
          const angles = ['low angle shot', 'close-up portrait', 'profile view', 'dramatic side lighting'];
          const matchedScene = scenes[selectedTags[0]] || 'dramatic setting, cinematic lighting';
          const randomAngle = angles[Math.floor(Math.random() * angles.length)];
          
          textarea.value = `exact same person exact same face, ${matchedScene}, ${randomAngle}, preserve facial features`;
        }
      } catch (e) {
        textarea.value = `exact same person exact same face, cinematic scene for ${selectedTags.join(' ')}, dramatic lighting, preserve facial features`;
      }
      
      logTest(`ğŸ¤– AI ç”Ÿæˆ Prompt: ${textarea.value}`);
    }

    // è¿è¡Œå¯¹æ¯”
    async function runComparison() {
      const prompts = [
        { id: 'A', prompt: document.getElementById('promptA').value },
        { id: 'B', prompt: document.getElementById('promptB').value },
        { id: 'C', prompt: document.getElementById('promptC').value }
      ].filter(p => p.prompt.trim());
      
      const imageBase64 = uploadedImageBase64 || document.getElementById('imageUrl').value;
      
      if (!imageBase64) {
        alert('è¯·å…ˆä¸Šä¼ å›¾ç‰‡æˆ–è¾“å…¥å›¾ç‰‡ URLï¼');
        return;
      }
      
      logTest(`\n${'='.repeat(50)}`);
      logTest(`ğŸš€ å¼€å§‹å¯¹æ¯”æµ‹è¯• | ${new Date().toLocaleTimeString()}`);
      logTest(`ğŸ“· å›¾ç‰‡: ${imageBase64.substring(0, 50)}...`);
      logTest(`ğŸ·ï¸ æ ‡ç­¾: ${selectedTags.join(', ') || 'æ— '}`);
      logTest(`${'='.repeat(50)}`);
      
      for (const { id, prompt } of prompts) {
        const resultDiv = document.getElementById(`result${id}`);
        const timeP = document.getElementById(`time${id}`);
        
        resultDiv.innerHTML = '<div class="loading text-indigo-400">â³ ç”Ÿæˆä¸­...</div>';
        logTest(`\nğŸ“ Prompt ${id}: ${prompt}`);
        
        const startTime = performance.now();
        
        try {
          const response = await fetch('/api/flux/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prompt: prompt,
              image: imageBase64,
              width: 512,
              height: 512
            })
          });
          
          const data = await response.json();
          const endTime = performance.now();
          const duration = ((endTime - startTime) / 1000).toFixed(2);
          
          if (data.success && data.image_base64) {
            resultDiv.innerHTML = `<img src="${data.image_base64}" class="w-full h-full object-cover rounded-lg">`;
            timeP.textContent = `âœ… ${duration}s`;
            timeP.className = 'text-xs text-green-400 mt-2 text-center';
            logTest(`âœ… ç»“æœ ${id}: æˆåŠŸ | è€—æ—¶ ${duration}s`);
          } else {
            resultDiv.innerHTML = `<span class="text-red-400 text-sm">ç”Ÿæˆå¤±è´¥</span>`;
            timeP.textContent = `âŒ ${duration}s`;
            logTest(`âŒ ç»“æœ ${id}: å¤±è´¥ | ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
          }
        } catch (e) {
          const endTime = performance.now();
          const duration = ((endTime - startTime) / 1000).toFixed(2);
          resultDiv.innerHTML = `<span class="text-red-400 text-sm">${e.message}</span>`;
          timeP.textContent = `âŒ ${duration}s`;
          logTest(`âŒ ç»“æœ ${id}: é”™è¯¯ | ${e.message}`);
        }
      }
      
      logTest(`\nğŸ“Š å¯¹æ¯”å®Œæˆï¼`);
    }

    // æ—¥å¿—
    function logTest(msg) {
      const log = document.getElementById('testLog');
      const time = new Date().toLocaleTimeString();
      log.innerHTML += `<p>${msg}</p>`;
      log.scrollTop = log.scrollHeight;
    }

    // å¯¼å‡º insights
    function exportInsights() {
      const log = document.getElementById('testLog').innerText;
      const blob = new Blob([`# Prompt Arena æµ‹è¯•è®°å½•\n\n${log}`], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `prompt-test-${Date.now()}.md`;
      a.click();
    }

    // åˆå§‹åŒ–
    initTags();
  </script>
</body>
</html>
