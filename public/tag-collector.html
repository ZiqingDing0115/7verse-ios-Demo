<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ‡ºğŸ‡¸ åŒ—ç¾ç½‘æ„Ÿæ ‡ç­¾åº“ - Research Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
      min-height: 100vh;
    }
    .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
    .tag-pill { transition: all 0.2s; }
    .tag-pill:hover { transform: scale(1.05); }
  </style>
</head>
<body class="text-white p-6">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-6">
      <h1 class="text-3xl font-bold mb-2">ğŸ‡ºğŸ‡¸ åŒ—ç¾ç½‘æ„Ÿæ ‡ç­¾åº“</h1>
      <p class="text-gray-400 text-sm">Research Tool Â· å¤šäººåä½œ Â· æ•°æ®äº‘ç«¯åŒæ­¥</p>
      <p class="text-gray-500 text-xs mt-1">å‚è€ƒå¹³å°ï¼šTikTok, Instagram, Character.AI, Janitor AI ç­‰</p>
    </div>
    
    <!-- ä½¿ç”¨æŒ‡å—ï¼ˆå¯æŠ˜å ï¼‰ -->
    <div class="glass rounded-2xl p-4 mb-6">
      <button onclick="toggleGuide()" class="w-full flex justify-between items-center text-left">
        <span class="font-semibold text-purple-300">ğŸ“– ä½¿ç”¨æŒ‡å—</span>
        <span id="guideArrow" class="text-gray-400 transition-transform">â–¼</span>
      </button>
      <div id="guideContent" class="hidden mt-4 text-sm text-gray-300 space-y-3">
        <div class="bg-gray-800/50 rounded-xl p-4">
          <h4 class="font-semibold text-white mb-2">ğŸ¯ è¿™æ˜¯ä»€ä¹ˆï¼Ÿ</h4>
          <p>è¿™æ˜¯ä¸€ä¸ªå›¢é˜Ÿå…±äº«çš„åŒ—ç¾å†…å®¹å¹³å°ç½‘æ„Ÿæ ‡ç­¾åº“ï¼Œç”¨äºæ”¶é›†å’Œæ•´ç† TikTokã€Instagram ç­‰å¹³å°çš„çƒ­é—¨æ ‡ç­¾ï¼Œå¸®åŠ©å†…å®¹åˆ›ä½œå’Œ AI è§’è‰²è®¾è®¡ã€‚</p>
        </div>
        
        <div class="bg-gray-800/50 rounded-xl p-4">
          <h4 class="font-semibold text-white mb-2">ğŸ“ å¦‚ä½•æ·»åŠ æ ‡ç­¾ï¼Ÿ</h4>
          <ul class="space-y-2 list-disc list-inside">
            <li><strong>æ‰‹åŠ¨è¾“å…¥</strong>ï¼šç›´æ¥è¾“å…¥è‹±æ–‡æ ‡ç­¾ï¼Œç³»ç»Ÿè‡ªåŠ¨ç¿»è¯‘ä¸­æ–‡</li>
            <li><strong>æˆªå›¾è§£æ</strong>ï¼šä¸Šä¼ æˆªå›¾ï¼Œæ‰‹åŠ¨è¾“å…¥çœ‹åˆ°çš„æ ‡ç­¾</li>
            <li><strong>æ‰¹é‡å¯¼å…¥</strong>ï¼šæ”¯æŒå¤šç§æ ¼å¼ç²˜è´´
              <ul class="ml-6 mt-1 text-gray-400 text-xs space-y-1">
                <li>â€¢ TikTok æ ‡ç­¾é¡µï¼š<code class="bg-gray-700 px-1 rounded">#NHL 2.5M posts</code></li>
                <li>â€¢ è¾¾äººç²¾çµï¼š<code class="bg-gray-700 px-1 rounded">relatable 36</code></li>
                <li>â€¢ çº¯æ ‡ç­¾ï¼š<code class="bg-gray-700 px-1 rounded">#hockey</code></li>
              </ul>
            </li>
          </ul>
        </div>
        
        <div class="bg-gray-800/50 rounded-xl p-4">
          <h4 class="font-semibold text-white mb-2">ğŸ·ï¸ æ ‡ç­¾åˆ†ç±»è¯´æ˜</h4>
          <div class="grid grid-cols-2 gap-2 text-xs">
            <div><span class="text-cyan-300">âœ¨ é£æ ¼ Style</span> - äººè®¾ã€æ€§æ ¼ã€å¤–è§‚</div>
            <div><span class="text-pink-300">ğŸ’• é™ªä¼´ Companion</span> - æƒ…æ„Ÿé™ªä¼´ã€æµªæ¼«</div>
            <div><span class="text-blue-300">ğŸ› ï¸ å®ç”¨ Utility</span> - å¯¼å¸ˆã€æ•™ç»ƒã€å’¨è¯¢</div>
            <div><span class="text-purple-300">ğŸ¬ IP</span> - åŠ¨æ¼«ã€æ¸¸æˆã€å½±è§†ã€æ˜æ˜Ÿ</div>
            <div><span class="text-amber-300">ğŸ“– å‰§æƒ… Story</span> - æ•…äº‹å¥—è·¯ã€æƒ…èŠ‚</div>
            <div><span class="text-green-300">ğŸ® äº’åŠ¨ Game</span> - æ¸¸æˆã€äº’åŠ¨ç©æ³•</div>
          </div>
        </div>
        
        <div class="bg-gray-800/50 rounded-xl p-4">
          <h4 class="font-semibold text-white mb-2">ğŸ’¡ å°æŠ€å·§</h4>
          <ul class="space-y-1 text-gray-400">
            <li>â€¢ ç‚¹å‡»ä»»æ„æ ‡ç­¾å¯<strong class="text-white">å¤åˆ¶</strong>åˆ°å‰ªè´´æ¿</li>
            <li>â€¢ æ‚¬åœæ ‡ç­¾å¯æŸ¥çœ‹<strong class="text-white">è¯¦ç»†ä¿¡æ¯</strong>ï¼ˆæ¥æºã€çƒ­åº¦ã€æ—¶é—´ï¼‰</li>
            <li>â€¢ å³ä¸Šè§’ ğŸ‘¤ è®¾ç½®ä½ çš„åå­—ï¼Œæ“ä½œä¼šè®°å½•åˆ°å†å²</li>
            <li>â€¢ çƒ­åº¦æ•°å­— = TikTok ä¸Šè¯¥æ ‡ç­¾çš„ä½¿ç”¨é¢‘ç‡</li>
            <li>â€¢ ğŸ”¥ = çƒ­é—¨æ ‡ç­¾ï¼ˆçƒ­åº¦â‰¥20ï¼‰ï½œâ­ = è¾ƒçƒ­ï¼ˆçƒ­åº¦â‰¥10ï¼‰</li>
          </ul>
        </div>
        
        <div class="text-center text-gray-500 text-xs pt-2">
          æœ‰é—®é¢˜æ‰¾ @ziqing ï½œæ•°æ®æ¯æ¬¡æ‰“å¼€è‡ªåŠ¨åŒæ­¥
        </div>
      </div>
    </div>
    
    <!-- å³ä¸Šè§’æ“ä½œæŒ‰é’® -->
    <div class="fixed top-4 right-4 flex gap-2 z-40">
      <button onclick="showUserModal()" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-xl px-3 py-2 text-sm flex items-center gap-2 transition" title="è®¾ç½®ç”¨æˆ·å">
        <span>ğŸ‘¤</span>
        <span id="currentUserDisplay" class="hidden sm:inline text-gray-400">æœªè®¾ç½®</span>
      </button>
      <button onclick="toggleHistory()" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-xl px-3 py-2 text-sm flex items-center gap-2 transition" title="æŸ¥çœ‹å†å²è®°å½•">
        <span>ğŸ“œ</span>
        <span class="hidden sm:inline">å†å²</span>
      </button>
    </div>
    
    <!-- å†å²è®°å½•é¢æ¿ -->
    <div id="historyPanel" class="fixed top-0 right-0 h-full w-80 bg-gray-900 border-l border-gray-700 shadow-2xl transform translate-x-full transition-transform duration-300 z-50 overflow-hidden">
      <div class="p-4 border-b border-gray-700 flex justify-between items-center">
        <h3 class="font-semibold">ğŸ“œ æ“ä½œå†å²</h3>
        <button onclick="toggleHistory()" class="text-gray-400 hover:text-white">âœ•</button>
      </div>
      <div id="historyList" class="p-4 overflow-y-auto" style="height: calc(100% - 60px);">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
    
    <!-- èƒŒæ™¯é®ç½© -->
    <div id="historyOverlay" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleHistory()"></div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="glass rounded-2xl p-6 mb-6">
      <h2 class="text-lg font-semibold mb-4">â• æ·»åŠ æ ‡ç­¾</h2>
      
      <!-- è¾“å…¥æ¨¡å¼åˆ‡æ¢ -->
      <div class="flex gap-2 mb-4 flex-wrap">
        <button onclick="setInputMode('manual')" id="modeManual" class="px-4 py-2 rounded-lg text-sm font-medium bg-purple-500/30 text-purple-300 border border-purple-500/50">
          âŒ¨ï¸ æ‰‹åŠ¨è¾“å…¥
        </button>
        <button onclick="setInputMode('screenshot')" id="modeScreenshot" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 border border-gray-600 hover:bg-gray-600">
          ğŸ“· æˆªå›¾è§£æ
        </button>
        <button onclick="setInputMode('batch')" id="modeBatch" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 border border-gray-600 hover:bg-gray-600">
          ğŸ“‹ æ‰¹é‡è§£æ
        </button>
      </div>

      <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
      <div id="manualInput">
        <div class="flex gap-3 mb-3">
          <input 
            type="text" 
            id="tagInput" 
            placeholder="è‹±æ–‡æ ‡ç­¾ï¼Œå¦‚ï¼šFoxy, Bad Boy..."
            class="flex-1 bg-gray-800/50 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-purple-500 focus:outline-none"
          >
          <div class="flex-1 relative">
            <input 
              type="text" 
              id="tagCN" 
              placeholder="ä¸­æ–‡è¯´æ˜ï¼ˆå¯é€‰ï¼‰å¦‚ï¼šç‹ç³»ã€åç”·å­©..."
              class="w-full bg-gray-800/50 border border-gray-700 rounded-xl px-4 py-3 pr-20 text-white placeholder-gray-500 focus:border-purple-500 focus:outline-none"
            >
            <button 
              onclick="manualTranslate()"
              class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 text-xs bg-blue-600/50 hover:bg-blue-600 rounded-lg text-blue-200 transition"
              title="æ‰‹åŠ¨ç¿»è¯‘"
            >
              ğŸŒ ç¿»è¯‘
            </button>
          </div>
          <span id="translateStatus" class="hidden text-xs text-blue-300 whitespace-nowrap"></span>
          <button 
            onclick="addTag()"
            class="bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-3 rounded-xl font-medium hover:opacity-90 transition whitespace-nowrap"
          >
            æ·»åŠ 
          </button>
        </div>
        <div class="flex gap-3">
          <input 
            type="text" 
            id="sourceUrl" 
            placeholder="åŸè§†é¢‘é“¾æ¥ï¼ˆå¯é€‰ï¼‰å¦‚ï¼šhttps://tiktok.com/..."
            class="flex-1 bg-gray-800/30 border border-gray-700 rounded-xl px-4 py-2 text-white placeholder-gray-600 focus:border-purple-500 focus:outline-none text-sm"
          >
        </div>
      </div>

      <!-- æ‰¹é‡è§£ææ¨¡å¼ -->
      <div id="batchInput" class="hidden">
        <div class="bg-gradient-to-r from-orange-900/20 to-amber-900/20 border border-orange-700/30 rounded-xl p-4 mb-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-lg">ğŸ”¥</span>
            <span class="font-medium text-orange-300">æ‰¹é‡å¯¼å…¥çƒ­é—¨æ ‡ç­¾</span>
          </div>
          <p class="text-xs text-gray-400">
            æ”¯æŒå¤šç§æ ¼å¼ï¼š<code class="bg-gray-800 px-1 rounded">#NHL 2.5M posts</code> Â· 
            <code class="bg-gray-800 px-1 rounded">æ ‡ç­¾ é¢‘æ¬¡</code> Â· 
            <code class="bg-gray-800 px-1 rounded">#æ ‡ç­¾å</code>
          </p>
        </div>
        
        <textarea 
          id="batchTextarea" 
          rows="8"
          placeholder="æ”¯æŒå¤šç§æ ¼å¼ï¼Œç›´æ¥ç²˜è´´å³å¯ï¼š

æ ¼å¼1 - TikTokæ ‡ç­¾é¡µï¼š
#NHL 2.5M posts
#hockey 500K posts

æ ¼å¼2 - è¾¾äººç²¾çµï¼š
relatable  36
funny  6

æ ¼å¼3 - çº¯æ ‡ç­¾ï¼š
#sports
gaming"
          class="w-full bg-gray-800/50 border border-gray-700 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none font-mono text-sm"
        ></textarea>
        
        <div class="flex gap-3 mt-3">
          <button 
            onclick="parseBatchTags()"
            class="flex-1 bg-gradient-to-r from-orange-500 to-amber-500 px-6 py-3 rounded-xl font-medium hover:opacity-90 transition"
          >
            ğŸ” è§£ææ ‡ç­¾
          </button>
          <button 
            onclick="clearBatchPreview()"
            class="px-6 py-3 rounded-xl font-medium bg-gray-700 hover:bg-gray-600 transition"
          >
            æ¸…ç©º
          </button>
        </div>
        
        <!-- è§£æé¢„è§ˆ -->
        <div id="batchPreview" class="hidden mt-4">
          <div class="flex justify-between items-center mb-3">
            <span class="text-sm text-gray-400">è§£æç»“æœ (<span id="batchCount">0</span> ä¸ªæ ‡ç­¾)</span>
            <div class="flex gap-2">
              <button onclick="selectAllBatch(true)" class="text-xs text-blue-400 hover:text-blue-300">å…¨é€‰</button>
              <button onclick="selectAllBatch(false)" class="text-xs text-gray-400 hover:text-gray-300">å–æ¶ˆå…¨é€‰</button>
            </div>
          </div>
          
          <div id="batchTagsList" class="max-h-64 overflow-y-auto space-y-1 bg-gray-800/30 rounded-xl p-3">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </div>
          
          <!-- åŸè§†é¢‘é“¾æ¥ -->
          <div class="mt-3">
            <input 
              type="text" 
              id="batchSourceUrl" 
              placeholder="ğŸ”— åŸè§†é¢‘é“¾æ¥ï¼ˆå¯é€‰ï¼‰å¦‚ï¼šhttps://tiktok.com/..."
              class="w-full bg-gray-800/30 border border-gray-700 rounded-xl px-4 py-2 text-white placeholder-gray-500 focus:border-orange-500 focus:outline-none text-sm"
            >
          </div>
          
          <button 
            onclick="addBatchTags()"
            class="w-full mt-3 bg-gradient-to-r from-green-500 to-emerald-500 px-6 py-3 rounded-xl font-medium hover:opacity-90 transition"
          >
            âœ… æ·»åŠ é€‰ä¸­æ ‡ç­¾ï¼ˆæ ‡è®°æ¥æºï¼šè¾¾äººç²¾çµï¼‰
          </button>
        </div>
      </div>

      <!-- æˆªå›¾è§£ææ¨¡å¼ -->
      <div id="screenshotInput" class="hidden">
        <div class="border-2 border-dashed border-gray-600 rounded-xl p-6 text-center mb-4 hover:border-purple-500 transition cursor-pointer" onclick="document.getElementById('imageUpload').click()">
          <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
          <div id="uploadPlaceholder">
            <div class="text-4xl mb-2">ğŸ“·</div>
            <p class="text-gray-400">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æˆªå›¾</p>
            <p class="text-xs text-gray-500 mt-1">æ”¯æŒ TikTok, Instagram, Character.AI ç­‰å¹³å°æˆªå›¾</p>
          </div>
          <div id="imagePreview" class="hidden">
            <img id="previewImg" class="max-h-64 mx-auto rounded-lg mb-3">
            <button onclick="event.stopPropagation(); clearImage()" class="text-xs text-red-400 hover:text-red-300">æ¸…é™¤å›¾ç‰‡</button>
          </div>
        </div>
        
        <div class="bg-gray-800/50 rounded-xl p-4 mb-4">
          <p class="text-sm text-gray-400 mb-2">ğŸ‘€ çœ‹åˆ°çš„æ ‡ç­¾ï¼ˆä»æˆªå›¾ä¸­æå–ï¼‰ï¼š</p>
          <div class="flex gap-3">
            <input 
              type="text" 
              id="screenshotTagInput" 
              placeholder="è¾“å…¥æˆªå›¾ä¸­çœ‹åˆ°çš„æ ‡ç­¾ï¼Œé€—å·åˆ†éš”..."
              class="flex-1 bg-gray-700/50 border border-gray-600 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:border-purple-500 focus:outline-none"
            >
            <div class="flex-1 relative">
              <input 
                type="text" 
                id="screenshotTagCN" 
                placeholder="ä¸­æ–‡è¯´æ˜ï¼ˆå¯é€‰ï¼‰..."
                class="w-full bg-gray-700/50 border border-gray-600 rounded-xl px-4 py-3 pr-20 text-white placeholder-gray-500 focus:border-purple-500 focus:outline-none"
              >
              <button 
                onclick="manualTranslateScreenshot()"
                class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 text-xs bg-blue-600/50 hover:bg-blue-600 rounded-lg text-blue-200 transition"
                title="æ‰‹åŠ¨ç¿»è¯‘"
              >
                ğŸŒ ç¿»è¯‘
              </button>
            </div>
          </div>
          <button 
            onclick="addScreenshotTag()"
            class="mt-3 w-full bg-gradient-to-r from-cyan-500 to-blue-500 px-6 py-3 rounded-xl font-medium hover:opacity-90 transition"
          >
            ğŸ“· æ·»åŠ ï¼ˆæ ‡è®°æ¥æºï¼šæˆªå›¾è§£æï¼‰
          </button>
        </div>
        
        <div class="text-xs text-gray-500 bg-gray-800/30 rounded-lg p-3">
          ğŸ’¡ <strong>AI è§£ææç¤ºï¼š</strong>å¦‚æœæˆªå›¾å¤æ‚ï¼Œå¯ä»¥ç›´æ¥å‘ç»™ Cursor é‡Œçš„ Claudeï¼Œè®© AI å¸®ä½ æå–æ ‡ç­¾
        </div>
      </div>

      <!-- åˆ†ç±»å’Œå¹³å°é€‰æ‹© -->
      <div class="flex gap-3 flex-wrap mt-4 items-center">
        <select id="categorySelect" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm">
          <option value="style">âœ¨ é£æ ¼ Style</option>
          <option value="companion">ğŸ’• é™ªä¼´ Companion</option>
          <option value="utility">ğŸ› ï¸ å®ç”¨ Utility</option>
          <option value="ip">ğŸ¬ IP</option>
          <option value="story">ğŸ“– å‰§æƒ… Story</option>
          <option value="game">ğŸ® äº’åŠ¨ Game</option>
        </select>
        
        <select id="platformSelect" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-sm">
          <option value="">æ¥æºå¹³å°ï¼ˆå¯é€‰ï¼‰</option>
          <option value="tiktok">TikTok</option>
          <option value="instagram">Instagram</option>
          <option value="character.ai">Character.AI</option>
          <option value="janitor.ai">Janitor AI</option>
          <option value="twitter">Twitter/X</option>
          <option value="reddit">Reddit</option>
          <option value="youtube">YouTube</option>
          <option value="other">Other</option>
        </select>
        
        <span id="sourceIndicator" class="px-3 py-2 rounded-lg text-sm bg-gray-700 text-gray-400">
          æ¥æº: âŒ¨ï¸ æ‰‹åŠ¨
        </span>
        
        <!-- AI è‡ªåŠ¨åˆ†ç±»å¼€å…³ -->
        <label class="flex items-center gap-2 px-3 py-2 rounded-lg bg-purple-900/30 border border-purple-700/50 cursor-pointer hover:bg-purple-900/50 transition" title="ä½¿ç”¨ Gemini AI è‡ªåŠ¨è¯†åˆ«æ ‡ç­¾åˆ†ç±»">
          <input type="checkbox" id="aiAutoCategory" checked class="w-4 h-4 accent-purple-500">
          <span class="text-sm text-purple-300">ğŸ¤– AI åˆ†ç±»</span>
        </label>
        
        <!-- AI è‡ªåŠ¨ç¿»è¯‘å¼€å…³ -->
        <label class="flex items-center gap-2 px-3 py-2 rounded-lg bg-blue-900/30 border border-blue-700/50 cursor-pointer hover:bg-blue-900/50 transition" title="è‡ªåŠ¨å°†è‹±æ–‡æ ‡ç­¾ç¿»è¯‘ä¸ºä¸­æ–‡æ³¨é‡Š">
          <input type="checkbox" id="aiAutoTranslate" checked class="w-4 h-4 accent-blue-500">
          <span class="text-sm text-blue-300">ğŸŒ è‡ªåŠ¨ç¿»è¯‘</span>
        </label>
        
        <!-- Gemini API Key è®¾ç½® -->
        <button onclick="showApiKeyModal()" class="px-3 py-2 rounded-lg text-sm bg-gray-700 text-gray-400 hover:bg-gray-600 transition" title="è®¾ç½® Gemini API Key">
          âš™ï¸
        </button>
      </div>
      
      <!-- AI åˆ†ç±»çŠ¶æ€æç¤º -->
      <div id="aiCategoryStatus" class="hidden mt-3 text-sm px-3 py-2 rounded-lg bg-purple-900/20 border border-purple-700/30">
        <span class="text-purple-300">ğŸ”„ æ­£åœ¨åˆ†æ...</span>
      </div>
    </div>

    <!-- æ ‡ç­¾ç»Ÿè®¡ -->
    <div class="glass rounded-2xl p-4 mb-6">
      <div class="flex justify-between items-center mb-2">
        <span class="text-gray-400">å·²æ”¶é›†æ ‡ç­¾</span>
        <span class="text-2xl font-bold text-purple-400" id="tagCount">0</span>
      </div>
      <div class="flex gap-4 text-xs text-gray-500" id="sourceStats">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- æ ‡ç­¾å±•ç¤ºåŒº -->
    <div class="glass rounded-2xl p-6 mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">ğŸ“š æ ‡ç­¾åº“</h2>
        <div class="flex gap-2">
          <button onclick="batchTranslateTags()" class="text-sm text-blue-400 hover:text-blue-300 px-3 py-1 rounded-lg hover:bg-blue-900/30 transition">
            ğŸŒ è¡¥ç¿»è¯‘
          </button>
          <button onclick="deduplicateTags()" class="text-sm text-yellow-400 hover:text-yellow-300 px-3 py-1 rounded-lg hover:bg-yellow-900/30 transition">
            ğŸ”„ å»é‡
          </button>
          <button onclick="exportTags()" class="text-sm text-gray-400 hover:text-white px-3 py-1 rounded-lg hover:bg-gray-700 transition">
            å¯¼å‡º JSON
          </button>
          <button onclick="clearAll()" class="text-sm text-red-400 hover:text-red-300 px-3 py-1 rounded-lg hover:bg-red-900/30 transition">
            æ¸…ç©º
          </button>
        </div>
      </div>
      
      <div id="tagContainer" class="space-y-4">
        <!-- åŠ¨æ€ç”Ÿæˆ -->
      </div>
      
      <div id="emptyState" class="text-center py-8 text-gray-500">
        è¿˜æ²¡æœ‰æ ‡ç­¾ï¼Œå¼€å§‹æ·»åŠ å§ï¼
      </div>
    </div>

    <!-- å¿«æ·ç¤ºä¾‹ -->
    <div class="glass rounded-2xl p-6">
      <h2 class="text-lg font-semibold mb-4">ğŸ’¡ çƒ­é—¨åŒ—ç¾ç½‘æ„Ÿæ ‡ç­¾å‚è€ƒ</h2>
      <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
        <button onclick="quickAdd('Foxy', 'style', 'ç‹ç³»/å¦–åªš')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ¦Š Foxy <span class="text-xs opacity-50">ç‹ç³»</span></button>
        <button onclick="quickAdd('Bad Boy', 'style', 'åç”·å­©')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ˜ Bad Boy <span class="text-xs opacity-50">åç”·å­©</span></button>
        <button onclick="quickAdd('Soft Boy', 'style', 'å¥¶ç‹—ç³»')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ¶ Soft Boy <span class="text-xs opacity-50">å¥¶ç‹—</span></button>
        <button onclick="quickAdd('Cold Outside Warm Inside', 'style', 'å¤–å†·å†…çƒ­')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ§Š Cold Outside <span class="text-xs opacity-50">å¤–å†·å†…çƒ­</span></button>
        <button onclick="quickAdd('Daddy', 'relationship', 'çˆ¹ç³»/éœ¸é“')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ”¥ Daddy <span class="text-xs opacity-50">çˆ¹ç³»</span></button>
        <button onclick="quickAdd('Mommy', 'relationship', 'å§ç³»/å¾¡å§')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ’‹ Mommy <span class="text-xs opacity-50">å§ç³»</span></button>
        <button onclick="quickAdd('Sugar Daddy', 'relationship', 'é‡‘ä¸»/åŒ…å…»')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ’° Sugar Daddy <span class="text-xs opacity-50">é‡‘ä¸»</span></button>
        <button onclick="quickAdd('Toxic Ex', 'relationship', 'æ¸£å‰ä»»')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">â˜ ï¸ Toxic Ex <span class="text-xs opacity-50">æ¸£å‰ä»»</span></button>
        <button onclick="quickAdd('Situationship', 'relationship', 'æš§æ˜§å…³ç³»')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ’­ Situationship <span class="text-xs opacity-50">æš§æ˜§</span></button>
        <button onclick="quickAdd('Enemies to Lovers', 'trope', 'ç›¸çˆ±ç›¸æ€')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">âš”ï¸ Enemies to Lovers <span class="text-xs opacity-50">ç›¸çˆ±ç›¸æ€</span></button>
        <button onclick="quickAdd('Slow Burn', 'trope', 'æ…¢çƒ­/æ—¥ä¹…ç”Ÿæƒ…')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ”¥ Slow Burn <span class="text-xs opacity-50">æ…¢çƒ­</span></button>
        <button onclick="quickAdd('Friends to Lovers', 'trope', 'å‹è¾¾ä»¥ä¸Š')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ’• Friends to Lovers <span class="text-xs opacity-50">å‹è¾¾ä»¥ä¸Š</span></button>
        <button onclick="quickAdd('Dom', 'vibe', 'æ”¯é…/S')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ‘‘ Dom <span class="text-xs opacity-50">S/æ”¯é…</span></button>
        <button onclick="quickAdd('Sub', 'vibe', 'é¡ºä»/M')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ”— Sub <span class="text-xs opacity-50">M/é¡ºä»</span></button>
        <button onclick="quickAdd('Possessive', 'vibe', 'å æœ‰æ¬²å¼º')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ”’ Possessive <span class="text-xs opacity-50">å æœ‰æ¬²</span></button>
        <button onclick="quickAdd('Yandere', 'vibe', 'ç—…å¨‡')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ”ª Yandere <span class="text-xs opacity-50">ç—…å¨‡</span></button>
        <button onclick="quickAdd('Tsundere', 'vibe', 'å‚²å¨‡')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ˜¤ Tsundere <span class="text-xs opacity-50">å‚²å¨‡</span></button>
        <button onclick="quickAdd('Flirty', 'vibe', 'æ’©äºº/è°ƒæƒ…')" class="bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded-lg text-left transition">ğŸ˜ Flirty <span class="text-xs opacity-50">æ’©äºº</span></button>
      </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none z-50">
      <span id="toastMessage"></span>
    </div>
    
    <!-- æ ‡ç­¾è¯¦æƒ… Tooltip -->
    <div id="tagTooltip" class="fixed z-50 bg-gray-900 border border-gray-700 rounded-xl p-4 shadow-2xl max-w-sm opacity-0 transition-opacity duration-200" style="display: none;">
      <div id="tooltipContent"></div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-8 text-gray-500 text-xs">
      <p>ğŸ’¡ æç¤ºï¼šä½ ä¹Ÿå¯ä»¥ä¸Šä¼ æˆªå›¾ï¼Œè®© Claude è§£æé‡Œé¢çš„æ ‡ç­¾</p>
      <p class="mt-1">åœ¨ Cursor ä¸­ç›´æ¥å‘å›¾ç‰‡ç»™æˆ‘ï¼Œæˆ‘ä¼šå¸®ä½ æå–æ ‡ç­¾å¹¶æ·»åŠ åˆ°è¿™é‡Œ</p>
    </div>
  </div>

  <script>
    // æ ‡ç­¾æ•°æ®ï¼ˆä½¿ç”¨ localStorage æŒä¹…åŒ–ï¼‰
    let tagsData = JSON.parse(localStorage.getItem('northAmericaTags') || '[]');
    let currentInputMode = 'manual'; // 'manual' or 'screenshot'
    let currentImageData = null;
    
    // åˆ†ç±»é…ç½®
    // L1 ä¸»åˆ†ç±»é…ç½®ï¼ˆç²¾ç®€ä¸º6ä¸ªï¼‰
    const categoryConfig = {
      utility: { 
        label: 'ğŸ› ï¸ å®ç”¨ Utility', 
        color: 'bg-blue-500/20 text-blue-300 border-blue-500/40',
        desc: 'èŒåœºå¯¼å¸ˆã€è¯­è¨€æ•™ç»ƒã€å¿ƒç†å’¨è¯¢',
        keywords: ['coach', 'mentor', 'tutor', 'teacher', 'therapist', 'counselor', 'advisor', 'consultant', 'helper', 'guide', 'trainer', 'professor', 'doctor', 'lawyer']
      },
      companion: { 
        label: 'ğŸ’• é™ªä¼´ Companion', 
        color: 'bg-pink-500/20 text-pink-300 border-pink-500/40',
        desc: 'æµªæ¼«ã€æ—¥å¸¸ã€æ²»æ„ˆã€æƒ…æ„Ÿé™ªä¼´',
        keywords: ['boyfriend', 'girlfriend', 'husband', 'wife', 'lover', 'crush', 'soulmate', 'partner', 'romantic', 'comfort', 'cuddle', 'wholesome', 'soft', 'caring', 'sweet', 'gentle', 'healing', 'support']
      },
      ip: { 
        label: 'ğŸ¬ IP', 
        color: 'bg-purple-500/20 text-purple-300 border-purple-500/40',
        desc: 'åŠ¨æ¼«ã€æ¸¸æˆã€å½±è§†ã€åäºº',
        keywords: ['anime', 'manga', 'game', 'movie', 'series', 'netflix', 'marvel', 'dc', 'disney', 'kpop', 'idol', 'celebrity', 'character', 'cosplay', 'fandom']
      },
      story: { 
        label: 'ğŸ“– å‰§æƒ… Story', 
        color: 'bg-amber-500/20 text-amber-300 border-amber-500/40',
        desc: 'æ•…äº‹å¥—è·¯ã€æƒ…èŠ‚è®¾å®šã€Trope',
        keywords: ['enemies', 'lovers', 'slowburn', 'angst', 'fluff', 'drama', 'revenge', 'betrayal', 'secret', 'forbidden', 'arranged', 'fake', 'dating', 'marriage', 'childhood', 'reunion', 'AU', 'fantasy']
      },
      game: { 
        label: 'ğŸ® äº’åŠ¨ Game', 
        color: 'bg-green-500/20 text-green-300 border-green-500/40',
        desc: 'æ¸¸æˆç©æ³•ã€äº’åŠ¨æœºåˆ¶',
        keywords: ['quiz', 'puzzle', 'riddle', 'survival', 'adventure', 'mystery', 'detective', 'escape', 'challenge', 'simulation', 'roleplay', 'RPG', 'choose', 'decision']
      },
      style: { 
        label: 'âœ¨ é£æ ¼ Style', 
        color: 'bg-cyan-500/20 text-cyan-300 border-cyan-500/40',
        desc: 'å¤–è§‚é£æ ¼ã€äººè®¾æ ‡ç­¾ã€æ€§æ ¼',
        keywords: ['foxy', 'badboy', 'bad boy', 'cold', 'tsundere', 'yandere', 'possessive', 'dominant', 'submissive', 'flirty', 'mysterious', 'dark', 'gothic', 'aesthetic', 'cute', 'hot', 'sexy', 'mafia', 'ceo', 'prince', 'vampire', 'werewolf', 'demon', 'angel']
      },
    };
    
    // æ¥æºé…ç½®
    const sourceConfig = {
      manual: { label: 'âŒ¨ï¸ æ‰‹åŠ¨', color: 'text-gray-400' },
      screenshot: { label: 'ğŸ“· æˆªå›¾', color: 'text-cyan-400' },
      ai: { label: 'ğŸ¤– AIè§£æ', color: 'text-purple-400' },
      batch: { label: 'ğŸ“‹ è¾¾äººç²¾çµ', color: 'text-orange-400' },
    };
    
    // æ‰¹é‡è§£æä¸´æ—¶å­˜å‚¨
    let parsedBatchTags = [];
    
    // å†å²è®°å½•
    let historyData = JSON.parse(localStorage.getItem('tagHistory') || '[]');
    let currentUser = localStorage.getItem('tagUser') || '';
    
    // æ·»åŠ å†å²è®°å½•
    function addHistory(action, details) {
      const record = {
        id: Date.now(),
        user: currentUser || 'åŒ¿åç”¨æˆ·',
        action: action,
        details: details,
        timestamp: new Date().toISOString(),
      };
      historyData.unshift(record);
      // åªä¿ç•™æœ€è¿‘ 100 æ¡
      if (historyData.length > 100) {
        historyData = historyData.slice(0, 100);
      }
      localStorage.setItem('tagHistory', JSON.stringify(historyData));
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'åˆšåˆš';
      if (diff < 3600000) return Math.floor(diff / 60000) + ' åˆ†é’Ÿå‰';
      if (diff < 86400000) return Math.floor(diff / 3600000) + ' å°æ—¶å‰';
      
      return date.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }) + ' ' + 
             date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }
    
    // åˆ‡æ¢å†å²é¢æ¿
    // åˆ‡æ¢ä½¿ç”¨æŒ‡å—
    function toggleGuide() {
      const content = document.getElementById('guideContent');
      const arrow = document.getElementById('guideArrow');
      const isHidden = content.classList.contains('hidden');
      
      if (isHidden) {
        content.classList.remove('hidden');
        arrow.style.transform = 'rotate(180deg)';
      } else {
        content.classList.add('hidden');
        arrow.style.transform = 'rotate(0deg)';
      }
    }
    
    function toggleHistory() {
      const panel = document.getElementById('historyPanel');
      const overlay = document.getElementById('historyOverlay');
      const isOpen = !panel.classList.contains('translate-x-full');
      
      if (isOpen) {
        panel.classList.add('translate-x-full');
        overlay.classList.add('hidden');
      } else {
        renderHistory();
        panel.classList.remove('translate-x-full');
        overlay.classList.remove('hidden');
      }
    }
    
    // æ¸²æŸ“å†å²è®°å½•
    function renderHistory() {
      const list = document.getElementById('historyList');
      
      if (historyData.length === 0) {
        list.innerHTML = '<p class="text-gray-500 text-center py-8">æš‚æ— æ“ä½œè®°å½•</p>';
        return;
      }
      
      let html = '<div class="space-y-3">';
      historyData.forEach(record => {
        const actionIcons = {
          'add': 'â•',
          'add_batch': 'ğŸ“‹',
          'add_screenshot': 'ğŸ“·',
          'delete': 'ğŸ—‘ï¸',
          'clear': 'ğŸ§¹',
          'dedupe': 'ğŸ”„',
          'export': 'ğŸ“¤',
        };
        const icon = actionIcons[record.action] || 'ğŸ“';
        
        html += `
          <div class="bg-gray-800/50 rounded-lg p-3 text-sm">
            <div class="flex items-start gap-2">
              <span class="text-lg">${icon}</span>
              <div class="flex-1">
                <div class="flex justify-between items-start">
                  <span class="font-medium text-purple-300">${record.user}</span>
                  <span class="text-xs text-gray-500">${formatTime(record.timestamp)}</span>
                </div>
                <p class="text-gray-300 mt-1">${record.details}</p>
              </div>
            </div>
          </div>
        `;
      });
      html += '</div>';
      
      list.innerHTML = html;
    }
    
    // ç”¨æˆ·è®¾ç½®å¼¹çª—
    function showUserModal() {
      const newUser = prompt('è®¾ç½®ä½ çš„ç”¨æˆ·åï¼ˆç”¨äºå†å²è®°å½•ï¼‰:', currentUser);
      if (newUser !== null) {
        currentUser = newUser.trim() || 'åŒ¿åç”¨æˆ·';
        localStorage.setItem('tagUser', currentUser);
        updateUserDisplay();
        showToast(`ğŸ‘¤ ç”¨æˆ·åå·²è®¾ç½®ï¼š${currentUser}`, 'success');
      }
    }
    
    // æ›´æ–°ç”¨æˆ·æ˜¾ç¤º
    function updateUserDisplay() {
      const display = document.getElementById('currentUserDisplay');
      if (display) {
        display.textContent = currentUser || 'æœªè®¾ç½®';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // åˆ†ç±»å…³é”®è¯åº“ï¼ˆåŸºäºç°æœ‰æ ‡ç­¾åº“ï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // å…³é”®è¯æ˜ å°„ï¼ˆç”¨äºæœ¬åœ°å¿«é€Ÿåˆ†ç±»ï¼‰
    const categoryKeywords = {
      // ğŸ› ï¸ å®ç”¨ Utility - èŒåœºå¯¼å¸ˆã€è¯­è¨€æ•™ç»ƒã€å¿ƒç†å’¨è¯¢
      utility: [
        'coach', 'mentor', 'tutor', 'teacher', 'therapist', 'counselor', 'advisor', 'consultant',
        'helper', 'guide', 'trainer', 'professor', 'doctor', 'lawyer', 'expert', 'assistant',
        'study', 'learn', 'practice', 'homework', 'language', 'english', 'spanish', 'japanese',
        'career', 'interview', 'resume', 'motivation', 'productivity', 'habit', 'goal',
        'å¯¼å¸ˆ', 'æ•™ç»ƒ', 'å’¨è¯¢', 'è¾…å¯¼', 'å­¦ä¹ ', 'èŒåœº', 'é¢è¯•'
      ],
      // ğŸ’• é™ªä¼´ Companion - æµªæ¼«ã€æ—¥å¸¸ã€æ²»æ„ˆã€æƒ…æ„Ÿé™ªä¼´
      companion: [
        'boyfriend', 'girlfriend', 'husband', 'wife', 'lover', 'crush', 'soulmate', 'partner',
        'romantic', 'comfort', 'cuddle', 'wholesome', 'soft', 'caring', 'sweet', 'gentle',
        'healing', 'support', 'listen', 'vent', 'chat', 'talk', 'friend', 'bestie', 'bff',
        'diary', 'daily', 'slice of life', 'cozy', 'warm', 'safe', 'cute', 'adorable',
        'daddy', 'mommy', 'sugar', 'situationship', 'fwb', 'clingy', 'needy', 'protective',
        'é™ªä¼´', 'æ²»æ„ˆ', 'æµªæ¼«', 'æ—¥å¸¸', 'å€¾å¬', 'æš–å¿ƒ', 'ç”·å‹', 'å¥³å‹', 'æ‹äºº'
      ],
      // ğŸ¬ IP - åŠ¨æ¼«ã€æ¸¸æˆã€å½±è§†ã€åäºº
      ip: [
        'anime', 'manga', 'webtoon', 'game', 'gaming', 'movie', 'film', 'series', 'show',
        'netflix', 'marvel', 'dc', 'disney', 'pixar', 'ghibli', 'kpop', 'jpop', 'idol',
        'celebrity', 'star', 'character', 'cosplay', 'fandom', 'fanfic', 'oc',
        'genshin', 'honkai', 'valorant', 'league', 'minecraft', 'roblox', 'fortnite',
        'harry potter', 'twilight', 'hunger games', 'stranger things', 'squid game',
        'bts', 'blackpink', 'enhypen', 'stray kids', 'seventeen', 'twice', 'aespa',
        'åŠ¨æ¼«', 'æ¸¸æˆ', 'å½±è§†', 'å¶åƒ', 'æ˜æ˜Ÿ', 'è§’è‰²', 'IP'
      ],
      // ğŸ“– å‰§æƒ… Story - æ•…äº‹å¥—è·¯ã€æƒ…èŠ‚è®¾å®š
      story: [
        'enemies to lovers', 'friends to lovers', 'slow burn', 'fake dating', 'arranged marriage',
        'second chance', 'love triangle', 'forbidden love', 'age gap', 'size difference',
        'forced proximity', 'only one bed', 'grumpy sunshine', 'opposites attract',
        'hurt comfort', 'angst', 'fluff', 'drama', 'revenge', 'betrayal', 'secret',
        'redemption', 'found family', 'childhood friend', 'first love', 'unrequited',
        'mystery', 'thriller', 'horror', 'fantasy', 'scifi', 'apocalypse', 'zombie',
        'AU', 'alternate universe', 'isekai', 'reincarnation', 'time travel',
        'ç›¸çˆ±ç›¸æ€', 'æ…¢çƒ­', 'æ—¥ä¹…ç”Ÿæƒ…', 'é’æ¢…ç«¹é©¬', 'è™æ‹', 'ç”œå® ', 'æ‚¬ç–‘', 'å¥‡å¹»'
      ],
      // ğŸ® äº’åŠ¨ Game - æ¸¸æˆç©æ³•ã€äº’åŠ¨æœºåˆ¶
      game: [
        'quiz', 'puzzle', 'riddle', 'trivia', 'guess', 'survival', 'adventure', 'escape',
        'mystery', 'detective', 'investigate', 'solve', 'challenge', 'competition',
        'simulation', 'roleplay', 'RPG', 'choose', 'decision', 'branch', 'ending',
        'dating sim', 'visual novel', 'text adventure', 'interactive', 'play',
        'çŒœè°œ', 'ç”Ÿå­˜', 'å†’é™©', 'æ¨ç†', 'ä¾¦æ¢', 'å…»æˆ', 'ç»è¥', 'äº’åŠ¨'
      ],
      // âœ¨ é£æ ¼ Style - å¤–è§‚é£æ ¼ã€äººè®¾æ ‡ç­¾ã€æ€§æ ¼
      style: [
        'foxy', 'badboy', 'bad boy', 'soft boy', 'cold', 'cool', 'hot', 'sexy', 'handsome',
        'pretty', 'elegant', 'rough', 'fierce', 'innocent', 'mature', 'charming', 'mysterious',
        'playful', 'serious', 'wild', 'calm', 'tough', 'dom', 'sub', 'switch', 'brat',
        'possessive', 'jealous', 'obsessive', 'yandere', 'tsundere', 'kuudere', 'dandere',
        'flirty', 'teasing', 'dominant', 'submissive', 'controlling',
        'ceo', 'mafia', 'boss', 'prince', 'king', 'knight', 'vampire', 'demon', 'angel',
        'werewolf', 'ghost', 'alien', 'robot', 'soldier', 'assassin', 'spy', 'villain', 'hero',
        'dark academia', 'cottagecore', 'gothic', 'cyberpunk', 'aesthetic', 'vintage', 'y2k',
        'ç‹ç³»', 'å¥¶ç‹—', 'åç”·å­©', 'é«˜å†·', 'æ¸©æŸ”', 'éœ¸é“', 'ç—…å¨‡', 'å‚²å¨‡', 'æ€»è£', 'ç‹å­'
      ],
    };

    // æœ¬åœ°æ™ºèƒ½åˆ†ç±»
    function localSmartCategory(tagText) {
      const lowerTag = tagText.toLowerCase();
      
      for (const [category, keywords] of Object.entries(categoryKeywords)) {
        for (const keyword of keywords) {
          if (lowerTag.includes(keyword.toLowerCase()) || keyword.toLowerCase().includes(lowerTag)) {
            return category;
          }
        }
      }
      
      return null; // æœªåŒ¹é…
    }

    // AI åˆ†ç±»ï¼ˆè°ƒç”¨ Geminiï¼‰
    async function aiSmartCategory(tagText) {
      const statusEl = document.getElementById('aiCategoryStatus');
      statusEl.classList.remove('hidden');
      statusEl.innerHTML = '<span class="text-purple-300">ğŸ”„ Gemini åˆ†æä¸­...</span>';
      
      try {
        const prompt = `You are a tag categorization expert for character AI platforms.

Given the tag: "${tagText}"

Categorize it into ONE of these 6 categories:
- utility: Practical/functional characters (coach, mentor, tutor, therapist, career advisor, language teacher)
- companion: Emotional companionship (boyfriend, girlfriend, romantic partner, comfort, healing, daily chat)
- ip: IP-based characters (anime, game characters, movie/TV, K-pop idols, celebrities, fandoms)
- story: Story tropes and plot devices (enemies to lovers, slow burn, mystery, fantasy, drama)
- game: Interactive/game mechanics (quiz, puzzle, survival, detective, simulation, choose-your-adventure)
- style: Visual style, personality, character archetypes (Foxy, Bad Boy, CEO, Vampire, Yandere, Gothic)

Respond with ONLY the category name in lowercase, nothing else.`;

        // ä» localStorage è·å– API keyï¼Œæˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼ˆé¡¹ç›®é…ç½®ï¼‰
        const defaultKey = 'AIzaSyBIEPo2i5dNwg7ujMWxkNICs7P-O5W00os';
        const apiKey = localStorage.getItem('geminiApiKey') || defaultKey;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.1, maxOutputTokens: 50 }
          })
        });
        
        if (!response.ok) throw new Error('API è°ƒç”¨å¤±è´¥');
        
        const result = await response.json();
        let category = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim().toLowerCase();
        
        // æå–ç¬¬ä¸€ä¸ªå•è¯
        if (category) {
          category = category.split(/[\s\n]/)[0].replace(/[^a-z]/g, '');
        }
        
        if (category && categoryConfig[category]) {
          statusEl.innerHTML = `<span class="text-green-400">âœ… Gemini: ${categoryConfig[category].label}</span>`;
          setTimeout(() => statusEl.classList.add('hidden'), 2000);
          return category;
        }
        
        throw new Error('æ— æ•ˆåˆ†ç±»: ' + category);
      } catch (error) {
        console.warn('AI åˆ†ç±»å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è§„åˆ™:', error);
        statusEl.innerHTML = '<span class="text-yellow-400">âš ï¸ ä½¿ç”¨æœ¬åœ°è§„åˆ™</span>';
        setTimeout(() => statusEl.classList.add('hidden'), 2000);
        return localSmartCategory(tagText);
      }
    }

    // æ£€æµ‹æ˜¯å¦åŒ…å«ä¸­æ–‡
    function containsChinese(text) {
      return /[\u4e00-\u9fff]/.test(text);
    }
    
    // æ£€æµ‹æ˜¯å¦ä¸»è¦æ˜¯è‹±æ–‡ï¼ˆç”¨äºåˆ¤æ–­ç¿»è¯‘æ–¹å‘ï¼‰
    function isMainlyEnglish(text) {
      const englishChars = text.match(/[a-zA-Z]/g)?.length || 0;
      const chineseChars = text.match(/[\u4e00-\u9fff]/g)?.length || 0;
      return englishChars > chineseChars;
    }

    // AI ç¿»è¯‘å‡½æ•°
    async function aiTranslate(text, toLanguage = 'chinese') {
      const statusEl = document.getElementById('translateStatus');
      statusEl.classList.remove('hidden');
      statusEl.innerHTML = 'ğŸ”„ ç¿»è¯‘ä¸­...';
      
      try {
        const prompt = toLanguage === 'chinese' 
          ? `Translate this English tag/phrase to concise Chinese (2-4 characters if possible). 
             Only output the Chinese translation, nothing else.
             Keep it natural and commonly used in Chinese social media context.
             
             English: "${text}"
             Chinese:`
          : `Translate this Chinese tag/phrase to natural English.
             Only output the English translation, nothing else.
             
             Chinese: "${text}"
             English:`;

        const defaultKey = 'AIzaSyBIEPo2i5dNwg7ujMWxkNICs7P-O5W00os';
        const apiKey = localStorage.getItem('geminiApiKey') || defaultKey;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.3, maxOutputTokens: 100 }
          })
        });
        
        if (!response.ok) throw new Error('ç¿»è¯‘ API è°ƒç”¨å¤±è´¥');
        
        const result = await response.json();
        const translation = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
        
        if (translation) {
          statusEl.innerHTML = `<span class="text-green-400">âœ… å·²ç¿»è¯‘</span>`;
          setTimeout(() => statusEl.classList.add('hidden'), 1500);
          return translation;
        }
        
        throw new Error('ç¿»è¯‘ç»“æœä¸ºç©º');
      } catch (error) {
        console.warn('AI ç¿»è¯‘å¤±è´¥:', error);
        statusEl.innerHTML = `<span class="text-yellow-400">âš ï¸ ç¿»è¯‘å¤±è´¥</span>`;
        setTimeout(() => statusEl.classList.add('hidden'), 2000);
        return null;
      }
    }
    
    // æ‰‹åŠ¨ç¿»è¯‘æŒ‰é’®
    async function manualTranslate() {
      const tagInput = document.getElementById('tagInput');
      const cnInput = document.getElementById('tagCN');
      const tagText = tagInput.value.trim();
      
      if (!tagText) {
        showToast('âš ï¸ è¯·å…ˆè¾“å…¥æ ‡ç­¾', 'warning');
        return;
      }
      
      // åˆ¤æ–­ç¿»è¯‘æ–¹å‘
      if (containsChinese(tagText)) {
        // ä¸­æ–‡è½¬è‹±æ–‡ - æŠŠç¿»è¯‘ç»“æœæ”¾åˆ°è‹±æ–‡æ¡†ï¼ŒåŸä¸­æ–‡æ”¾åˆ°æ³¨é‡Š
        const english = await aiTranslate(tagText, 'english');
        if (english) {
          tagInput.value = english;
          cnInput.value = tagText;
          showToast(`ğŸŒ å·²ç¿»è¯‘ï¼š${tagText} â†’ ${english}`, 'success');
        }
      } else {
        // è‹±æ–‡è½¬ä¸­æ–‡ - ç¿»è¯‘ç»“æœæ”¾åˆ°ä¸­æ–‡æ³¨é‡Šæ¡†
        const chinese = await aiTranslate(tagText, 'chinese');
        if (chinese) {
          cnInput.value = chinese;
          showToast(`ğŸŒ å·²ç¿»è¯‘ï¼š${tagText} â†’ ${chinese}`, 'success');
        }
      }
    }
    
    // æˆªå›¾æ¨¡å¼æ‰‹åŠ¨ç¿»è¯‘
    async function manualTranslateScreenshot() {
      const tagInput = document.getElementById('screenshotTagInput');
      const cnInput = document.getElementById('screenshotTagCN');
      const tagText = tagInput.value.trim();
      
      if (!tagText) {
        showToast('âš ï¸ è¯·å…ˆè¾“å…¥æ ‡ç­¾', 'warning');
        return;
      }
      
      if (containsChinese(tagText)) {
        const english = await aiTranslate(tagText, 'english');
        if (english) {
          tagInput.value = english;
          cnInput.value = tagText;
          showToast(`ğŸŒ å·²ç¿»è¯‘ï¼š${tagText} â†’ ${english}`, 'success');
        }
      } else {
        const chinese = await aiTranslate(tagText, 'chinese');
        if (chinese) {
          cnInput.value = chinese;
          showToast(`ğŸŒ å·²ç¿»è¯‘ï¼š${tagText} â†’ ${chinese}`, 'success');
        }
      }
    }
    
    // é™é»˜ç¿»è¯‘ï¼ˆä¸æ˜¾ç¤ºçŠ¶æ€ï¼Œç”¨äºæ‰¹é‡ï¼‰
    async function silentTranslate(text) {
      if (!text || containsChinese(text)) return null;
      
      try {
        const prompt = `Translate this English tag/phrase to concise Chinese (2-4 characters if possible). 
Only output the Chinese translation, nothing else.
Keep it natural and commonly used in Chinese social media context.

English: "${text}"
Chinese:`;

        const defaultKey = 'AIzaSyBIEPo2i5dNwg7ujMWxkNICs7P-O5W00os';
        const apiKey = localStorage.getItem('geminiApiKey') || defaultKey;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { temperature: 0.3, maxOutputTokens: 100 }
          })
        });
        
        if (!response.ok) return null;
        
        const result = await response.json();
        return result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || null;
      } catch (error) {
        console.warn('ç¿»è¯‘å¤±è´¥:', text, error);
        return null;
      }
    }
    
    // æ‰¹é‡ç¿»è¯‘æ ‡ç­¾ï¼ˆä¸ºæ²¡æœ‰ä¸­æ–‡çš„æ ‡ç­¾æ·»åŠ ç¿»è¯‘ï¼‰
    async function batchTranslateTags() {
      const tagsNeedTranslation = tagsData.filter(t => !t.labelCN && !containsChinese(t.label));
      
      if (tagsNeedTranslation.length === 0) {
        showToast('âœ… æ‰€æœ‰æ ‡ç­¾å·²æœ‰ä¸­æ–‡æ³¨é‡Š', 'success');
        return;
      }
      
      showToast(`ğŸŒ æ­£åœ¨ç¿»è¯‘ ${tagsNeedTranslation.length} ä¸ªæ ‡ç­¾...`, 'success');
      
      let translatedCount = 0;
      
      // åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹5ä¸ªï¼Œé¿å…APIé™æµ
      for (let i = 0; i < tagsNeedTranslation.length; i += 5) {
        const batch = tagsNeedTranslation.slice(i, i + 5);
        const promises = batch.map(async (tag) => {
          const translation = await silentTranslate(tag.label);
          if (translation) {
            tag.labelCN = translation;
            translatedCount++;
          }
        });
        await Promise.all(promises);
        
        // æ¯æ‰¹ä¹‹é—´ç¨å¾®ç­‰å¾…
        if (i + 5 < tagsNeedTranslation.length) {
          await new Promise(r => setTimeout(r, 500));
        }
      }
      
      save();
      showToast(`ğŸŒ å·²ç¿»è¯‘ ${translatedCount} ä¸ªæ ‡ç­¾`, 'success');
      addHistory('translate', `æ‰¹é‡ç¿»è¯‘ ${translatedCount} ä¸ªæ ‡ç­¾`);
    }
    
    // è‡ªåŠ¨ç¿»è¯‘ï¼ˆè¾“å…¥æ—¶è§¦å‘ï¼‰
    async function autoTranslateTag(tagText, cnInputId = 'tagCN') {
      const cnInput = document.getElementById(cnInputId);
      
      // å¦‚æœä¸­æ–‡æ¡†å·²æœ‰å†…å®¹ï¼Œä¸è‡ªåŠ¨ç¿»è¯‘
      if (!cnInput || cnInput.value.trim()) return;
      
      // åªå¯¹è‹±æ–‡æ ‡ç­¾è‡ªåŠ¨ç¿»è¯‘æˆä¸­æ–‡
      if (tagText && !containsChinese(tagText) && tagText.length >= 2) {
        const chinese = await aiTranslate(tagText, 'chinese');
        if (chinese && !cnInput.value.trim()) {
          cnInput.value = chinese;
        }
      }
    }

    // æ™ºèƒ½åˆ†ç±»å…¥å£
    async function smartCategorize(tagText) {
      const useAI = document.getElementById('aiAutoCategory').checked;
      
      if (useAI) {
        // å…ˆç”¨æœ¬åœ°è§„åˆ™å¿«é€ŸåŒ¹é…
        const localResult = localSmartCategory(tagText);
        if (localResult) {
          // æœ¬åœ°èƒ½åŒ¹é…å°±ç›´æ¥ç”¨ï¼Œä¸è°ƒ AI
          document.getElementById('categorySelect').value = localResult;
          const statusEl = document.getElementById('aiCategoryStatus');
          statusEl.classList.remove('hidden');
          statusEl.innerHTML = `<span class="text-blue-400">âš¡ å¿«é€ŸåŒ¹é…: ${categoryConfig[localResult].label}</span>`;
          setTimeout(() => statusEl.classList.add('hidden'), 1500);
          return localResult;
        }
        
        // æœ¬åœ°åŒ¹é…ä¸åˆ°ï¼Œè°ƒ AI
        const aiResult = await aiSmartCategory(tagText);
        if (aiResult) {
          document.getElementById('categorySelect').value = aiResult;
          return aiResult;
        }
      }
      
      return null;
    }

    // åˆå§‹åŒ–
    function init() {
      renderTags();
      updateCount();
      updateUserDisplay();
      
      // è¾“å…¥æ¡†å¤±ç„¦æˆ–è¾“å…¥åè‡ªåŠ¨åˆ†ç±»
      const tagInput = document.getElementById('tagInput');
      const screenshotTagInput = document.getElementById('screenshotTagInput');
      
      let debounceTimer = null;
      
      // æ‰‹åŠ¨è¾“å…¥æ¨¡å¼
      let translateTimer = null;
      tagInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        clearTimeout(translateTimer);
        debounceTimer = setTimeout(() => {
          const text = e.target.value.trim();
          if (text && !text.includes(',')) {
            smartCategorize(text);
          }
        }, 500);
        // è‡ªåŠ¨ç¿»è¯‘å»¶è¿Ÿæ›´é•¿ä¸€äº›ï¼Œé¿å…é¢‘ç¹è°ƒç”¨
        translateTimer = setTimeout(() => {
          const text = e.target.value.trim();
          if (text && !text.includes(',')) {
            autoTranslateTag(text);
          }
        }, 1000);
      });
      
      // æˆªå›¾æ¨¡å¼
      let screenshotTranslateTimer = null;
      screenshotTagInput.addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        clearTimeout(screenshotTranslateTimer);
        debounceTimer = setTimeout(() => {
          const text = e.target.value.trim();
          if (text && !text.includes(',')) {
            smartCategorize(text);
          }
        }, 500);
        // è‡ªåŠ¨ç¿»è¯‘
        screenshotTranslateTimer = setTimeout(() => {
          const text = e.target.value.trim();
          if (text && !text.includes(',')) {
            autoTranslateTag(text, 'screenshotTagCN');
          }
        }, 1000);
      });
      
      // å›è½¦æ·»åŠ 
      tagInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addTag();
      });
      screenshotTagInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addScreenshotTag();
      });
    }
    
    // åˆ‡æ¢è¾“å…¥æ¨¡å¼
    function setInputMode(mode) {
      currentInputMode = mode;
      const manualBtn = document.getElementById('modeManual');
      const screenshotBtn = document.getElementById('modeScreenshot');
      const batchBtn = document.getElementById('modeBatch');
      const manualInput = document.getElementById('manualInput');
      const screenshotInput = document.getElementById('screenshotInput');
      const batchInput = document.getElementById('batchInput');
      const sourceIndicator = document.getElementById('sourceIndicator');
      
      // é‡ç½®æ‰€æœ‰æŒ‰é’®
      const inactiveClass = 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-400 border border-gray-600 hover:bg-gray-600';
      manualBtn.className = inactiveClass;
      screenshotBtn.className = inactiveClass;
      batchBtn.className = inactiveClass;
      
      // éšè—æ‰€æœ‰è¾“å…¥åŒº
      manualInput.classList.add('hidden');
      screenshotInput.classList.add('hidden');
      batchInput.classList.add('hidden');
      
      if (mode === 'manual') {
        manualBtn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-purple-500/30 text-purple-300 border border-purple-500/50';
        manualInput.classList.remove('hidden');
        sourceIndicator.innerHTML = 'æ¥æº: âŒ¨ï¸ æ‰‹åŠ¨';
      } else if (mode === 'screenshot') {
        screenshotBtn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-cyan-500/30 text-cyan-300 border border-cyan-500/50';
        screenshotInput.classList.remove('hidden');
        sourceIndicator.innerHTML = 'æ¥æº: ğŸ“· æˆªå›¾è§£æ';
      } else if (mode === 'batch') {
        batchBtn.className = 'px-4 py-2 rounded-lg text-sm font-medium bg-orange-500/30 text-orange-300 border border-orange-500/50';
        batchInput.classList.remove('hidden');
        sourceIndicator.innerHTML = 'æ¥æº: ğŸ“‹ è¾¾äººç²¾çµ';
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // æ‰¹é‡è§£æåŠŸèƒ½ï¼ˆè¾¾äººç²¾çµï¼‰
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // è§£ææ‰¹é‡æ ‡ç­¾
    // è§£ææ•°é‡å­—ç¬¦ä¸²ï¼ˆæ”¯æŒ 2.5M, 500K, 1.2B ç­‰æ ¼å¼ï¼‰
    function parseCount(countStr) {
      if (!countStr) return 0;
      const str = countStr.toString().toUpperCase().trim();
      
      // åŒ¹é…æ•°å­—å’Œå•ä½
      const match = str.match(/^([\d.]+)\s*([KMBT])?/i);
      if (!match) return parseInt(str) || 0;
      
      const num = parseFloat(match[1]);
      const unit = match[2]?.toUpperCase();
      
      switch (unit) {
        case 'K': return Math.round(num * 1000);
        case 'M': return Math.round(num * 1000000);
        case 'B': return Math.round(num * 1000000000);
        case 'T': return Math.round(num * 1000000000000);
        default: return Math.round(num);
      }
    }
    
    function parseBatchTags() {
      const textarea = document.getElementById('batchTextarea');
      const text = textarea.value.trim();
      
      if (!text) {
        alert('è¯·å…ˆç²˜è´´æ ‡ç­¾æ•°æ®');
        return;
      }
      
      // è§£ææ¯ä¸€è¡Œ
      const lines = text.split('\n');
      parsedBatchTags = [];
      
      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;
        
        let label = '';
        let frequency = 0;
        let parsed = false;
        
        // æ ¼å¼1: #NHL 2.5M posts æˆ– #NHL 2.5M
        const hashtagMatch = trimmed.match(/^#?(\w+)\s+([\d.]+[KMBT]?)\s*(posts?)?$/i);
        if (hashtagMatch) {
          label = hashtagMatch[1];
          frequency = parseCount(hashtagMatch[2]);
          parsed = true;
        }
        
        // æ ¼å¼2: æ ‡ç­¾å  é¢‘æ¬¡ï¼ˆè¾¾äººç²¾çµæ ¼å¼ï¼Œçº¯æ•°å­—ï¼‰
        if (!parsed) {
          const simpleMatch = trimmed.match(/^(.+?)\s+(\d+)$/);
          if (simpleMatch) {
            label = simpleMatch[1].trim().replace(/^#/, '');
            frequency = parseInt(simpleMatch[2]);
            parsed = true;
          }
        }
        
        // æ ¼å¼3: çº¯æ ‡ç­¾ï¼ˆæ— é¢‘æ¬¡ï¼‰
        if (!parsed && trimmed && !/^\d+$/.test(trimmed)) {
          label = trimmed.replace(/^#/, '');
          frequency = 0;
          parsed = true;
        }
        
        if (parsed && label) {
          // è¿‡æ»¤æ‰å¹³å°é€šç”¨æ ‡ç­¾
          const skipPatterns = [
            /^fyp/i, /^foryou/i, /^viral/i, /^trending/i, /^explore/i,
            /^xyzbca/i, /^xybca/i, /^zxycba/i, /^blowup/i, /^blowthisup/i,
            /^repost$/i, /^gif$/i, /^meme$/i,
          ];
          
          const shouldSkip = skipPatterns.some(p => p.test(label));
          const exists = tagsData.some(t => t.label.toLowerCase() === label.toLowerCase());
          
          parsedBatchTags.push({
            label,
            frequency,
            selected: !shouldSkip,
            skipped: shouldSkip,
            exists,
            category: localSmartCategory(label) || 'style',
          });
        }
      }
      
      // æŒ‰é¢‘æ¬¡æ’åº
      parsedBatchTags.sort((a, b) => b.frequency - a.frequency);
      
      // æ¸²æŸ“é¢„è§ˆ
      renderBatchPreview();
    }
    
    // æ¸²æŸ“æ‰¹é‡é¢„è§ˆ
    function renderBatchPreview() {
      const preview = document.getElementById('batchPreview');
      const list = document.getElementById('batchTagsList');
      const count = document.getElementById('batchCount');
      
      if (parsedBatchTags.length === 0) {
        preview.classList.add('hidden');
        return;
      }
      
      preview.classList.remove('hidden');
      count.textContent = parsedBatchTags.filter(t => t.selected).length;
      
      let html = '';
      parsedBatchTags.forEach((tag, i) => {
        const config = categoryConfig[tag.category] || categoryConfig.style;
        const statusClass = tag.skipped ? 'opacity-70' : '';
        // å·²å­˜åœ¨çš„æ ‡ç­¾ä¼šç´¯åŠ çƒ­åº¦ï¼Œæ˜¾ç¤ºä¸åŒçš„çŠ¶æ€
        const statusLabel = tag.exists ? '(+çƒ­åº¦)' : (tag.skipped ? '(å¹³å°æ ‡ç­¾)' : '');
        
        html += `
          <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-700/50 cursor-pointer ${statusClass}">
            <input 
              type="checkbox" 
              ${tag.selected ? 'checked' : ''} 
              ${tag.exists ? 'disabled' : ''}
              onchange="toggleBatchTag(${i})"
              class="w-4 h-4 accent-orange-500"
            >
            <span class="flex-1 font-medium">${tag.label}</span>
            ${tag.frequency > 0 ? `<span class="text-xs text-orange-400 font-mono">${tag.frequency}æ¬¡</span>` : ''}
            <span class="text-xs ${config.color} px-2 py-0.5 rounded ${config.color.replace('text-', 'bg-').replace('-300', '-900/30')}">${config.label.split(' ')[0]}</span>
            ${statusLabel ? `<span class="text-xs text-gray-500">${statusLabel}</span>` : ''}
          </label>
        `;
      });
      
      list.innerHTML = html;
    }
    
    // åˆ‡æ¢æ‰¹é‡æ ‡ç­¾é€‰ä¸­çŠ¶æ€
    function toggleBatchTag(index) {
      parsedBatchTags[index].selected = !parsedBatchTags[index].selected;
      document.getElementById('batchCount').textContent = parsedBatchTags.filter(t => t.selected).length;
    }
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function selectAllBatch(selectAll) {
      parsedBatchTags.forEach(tag => {
        if (!tag.exists) {
          tag.selected = selectAll;
        }
      });
      renderBatchPreview();
    }
    
    // æ·»åŠ æ‰¹é‡æ ‡ç­¾
    async function addBatchTags() {
      const selectedTags = parsedBatchTags.filter(t => t.selected);
      const platform = document.getElementById('platformSelect').value || 'tiktok';
      const sourceUrl = document.getElementById('batchSourceUrl')?.value?.trim() || '';
      
      if (selectedTags.length === 0) {
        showToast('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ ‡ç­¾', 'warning');
        return;
      }
      
      let addedCount = 0;
      let updatedCount = 0;
      const newTagIds = [];
      
      selectedTags.forEach(tag => {
        const existingTag = tagsData.find(t => t.label.toLowerCase() === tag.label.toLowerCase());
        
        if (existingTag) {
          existingTag.frequency = (existingTag.frequency || 0) + (tag.frequency || 0);
          existingTag.lastUpdated = new Date().toISOString();
          // å¦‚æœæœ‰æ–°çš„ sourceUrlï¼Œæ›´æ–°å®ƒ
          if (sourceUrl) existingTag.sourceUrl = sourceUrl;
          updatedCount++;
        } else {
          const newTag = {
            id: Date.now() + Math.random(),
            label: tag.label,
            labelCN: '',
            category: tag.category,
            platform: platform,
            source: 'batch',
            sourceUrl: sourceUrl || null,
            frequency: tag.frequency || 0,
            addedAt: new Date().toISOString(),
          };
          tagsData.push(newTag);
          newTagIds.push(newTag.id);
          addedCount++;
        }
      });
      
      save();
      clearBatchPreview();
      
      // æ¸…ç©ºåŸè§†é¢‘é“¾æ¥è¾“å…¥æ¡†
      const urlInput = document.getElementById('batchSourceUrl');
      if (urlInput) urlInput.value = '';
      
      // æ˜¾ç¤ºç»“æœ
      let message = '';
      if (addedCount > 0 && updatedCount > 0) {
        message = `ğŸ”¥ æ–°å¢ ${addedCount} ä¸ªï¼Œæ›´æ–° ${updatedCount} ä¸ªçƒ­åº¦`;
      } else if (addedCount > 0) {
        message = `ğŸ”¥ æˆåŠŸæ·»åŠ  ${addedCount} ä¸ªæ ‡ç­¾`;
      } else if (updatedCount > 0) {
        message = `ğŸ”„ æ›´æ–° ${updatedCount} ä¸ªæ ‡ç­¾çƒ­åº¦`;
      }
      showToast(message, 'success');
      addHistory('add_batch', `æ‰¹é‡å¤„ç†ï¼šæ–°å¢ ${addedCount} ä¸ªï¼Œæ›´æ–° ${updatedCount} ä¸ªçƒ­åº¦`);
      
      // è‡ªåŠ¨ç¿»è¯‘æ–°æ·»åŠ çš„æ ‡ç­¾
      if (addedCount > 0) {
        showToast(`ğŸŒ æ­£åœ¨ç¿»è¯‘ ${addedCount} ä¸ªæ–°æ ‡ç­¾...`, 'success');
        
        const newTags = tagsData.filter(t => newTagIds.includes(t.id));
        let translatedCount = 0;
        
        for (let i = 0; i < newTags.length; i += 5) {
          const batch = newTags.slice(i, i + 5);
          const promises = batch.map(async (tag) => {
            if (!tag.labelCN && !containsChinese(tag.label)) {
              const translation = await silentTranslate(tag.label);
              if (translation) {
                tag.labelCN = translation;
                translatedCount++;
              }
            }
          });
          await Promise.all(promises);
          if (i + 5 < newTags.length) {
            await new Promise(r => setTimeout(r, 300));
          }
        }
        
        save();
        if (translatedCount > 0) {
          showToast(`ğŸŒ å·²ç¿»è¯‘ ${translatedCount} ä¸ªæ ‡ç­¾`, 'success');
        }
      }
    }
    
    // æ¸…ç©ºæ‰¹é‡é¢„è§ˆ
    function clearBatchPreview() {
      document.getElementById('batchTextarea').value = '';
      document.getElementById('batchPreview').classList.add('hidden');
      parsedBatchTags = [];
    }
    
    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        currentImageData = e.target.result;
        document.getElementById('previewImg').src = currentImageData;
        document.getElementById('uploadPlaceholder').classList.add('hidden');
        document.getElementById('imagePreview').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
    
    // æ¸…é™¤å›¾ç‰‡
    function clearImage() {
      currentImageData = null;
      document.getElementById('imageUpload').value = '';
      document.getElementById('uploadPlaceholder').classList.remove('hidden');
      document.getElementById('imagePreview').classList.add('hidden');
    }
    
    // ä»æˆªå›¾æ·»åŠ æ ‡ç­¾
    function addScreenshotTag() {
      const input = document.getElementById('screenshotTagInput');
      const cnInput = document.getElementById('screenshotTagCN');
      const category = document.getElementById('categorySelect').value;
      const platform = document.getElementById('platformSelect').value;
      
      const tagText = input.value.trim();
      const cnText = cnInput.value.trim();
      
      if (!tagText) {
        showToast('âš ï¸ è¯·è¾“å…¥æ ‡ç­¾', 'warning');
        return;
      }
      
      const tags = tagText.split(',').map(t => t.trim()).filter(t => t);
      const cns = cnText.split(',').map(t => t.trim());
      
      let addedCount = 0;
      let skippedCount = 0;
      
      tags.forEach((tag, i) => {
        if (tagsData.some(t => t.label.toLowerCase() === tag.toLowerCase())) {
          skippedCount++;
          return;
        }
        
        tagsData.push({
          id: Date.now() + Math.random(),
          label: tag,
          labelCN: cns[i] || '',
          category: category,
          platform: platform || null,
          source: 'screenshot',
          hasImage: !!currentImageData,
          addedAt: new Date().toISOString(),
        });
        addedCount++;
      });
      
      save();
      input.value = '';
      cnInput.value = '';
      
      // æ˜¾ç¤ºç»“æœ
      const categoryLabel = categoryConfig[category]?.label || category;
      if (addedCount > 0) {
        showToast(`ğŸ“· æˆåŠŸæ·»åŠ  ${addedCount} ä¸ªæ ‡ç­¾ â†’ ${categoryLabel}ï¼Œå½“å‰å…± ${tagsData.length} ä¸ª`, 'success');
        addHistory('add_screenshot', `ä»æˆªå›¾æ·»åŠ  ${addedCount} ä¸ªæ ‡ç­¾åˆ° ${categoryLabel}`);
      } else if (skippedCount > 0) {
        showToast(`âš ï¸ æ ‡ç­¾å·²å­˜åœ¨ï¼Œè·³è¿‡ ${skippedCount} ä¸ª`, 'warning');
      }
    }

    // æ·»åŠ æ ‡ç­¾ï¼ˆæ‰‹åŠ¨æ¨¡å¼ï¼‰
    async function addTag() {
      const input = document.getElementById('tagInput');
      const cnInput = document.getElementById('tagCN');
      const urlInput = document.getElementById('sourceUrl');
      const category = document.getElementById('categorySelect').value;
      const platform = document.getElementById('platformSelect').value;
      
      const tagText = input.value.trim();
      const cnText = cnInput.value.trim();
      const sourceUrl = urlInput?.value?.trim() || '';
      
      if (!tagText) {
        showToast('âš ï¸ è¯·è¾“å…¥æ ‡ç­¾', 'warning');
        return;
      }
      
      // æ”¯æŒé€—å·åˆ†éš”æ‰¹é‡æ·»åŠ 
      const tags = tagText.split(',').map(t => t.trim()).filter(t => t);
      const cns = cnText.split(',').map(t => t.trim());
      
      let addedCount = 0;
      let skippedCount = 0;
      const skippedTags = [];
      const newTagIds = [];
      
      tags.forEach((tag, i) => {
        if (tagsData.some(t => t.label.toLowerCase() === tag.toLowerCase())) {
          skippedCount++;
          skippedTags.push(tag);
          return;
        }
        
        const newTag = {
          id: Date.now() + Math.random(),
          label: tag,
          labelCN: cns[i] || '',
          category: category,
          platform: platform || null,
          source: 'manual',
          sourceUrl: sourceUrl || null,
          addedAt: new Date().toISOString(),
        };
        tagsData.push(newTag);
        if (!newTag.labelCN) newTagIds.push(newTag.id);
        addedCount++;
      });
      
      save();
      input.value = '';
      cnInput.value = '';
      if (urlInput) urlInput.value = '';
      
      // è‡ªåŠ¨ç¿»è¯‘æ²¡æœ‰ä¸­æ–‡çš„æ ‡ç­¾
      if (newTagIds.length > 0) {
        const tagsToTranslate = tagsData.filter(t => newTagIds.includes(t.id));
        for (const tag of tagsToTranslate) {
          if (!containsChinese(tag.label)) {
            const translation = await silentTranslate(tag.label);
            if (translation) tag.labelCN = translation;
          }
        }
        save();
      }
      
      // æ˜¾ç¤ºç»“æœ
      const categoryLabel = categoryConfig[category]?.label || category;
      if (addedCount === 1 && skippedCount === 0) {
        showToast(`âœ… æˆåŠŸæ·»åŠ ã€Œ${tags[0]}ã€â†’ ${categoryLabel}ï¼Œå½“å‰å…± ${tagsData.length} ä¸ªæ ‡ç­¾`, 'success');
        addHistory('add', `æ·»åŠ æ ‡ç­¾ã€Œ${tags[0]}ã€åˆ° ${categoryLabel}`);
      } else if (addedCount > 1 && skippedCount === 0) {
        showToast(`âœ… æˆåŠŸæ·»åŠ  ${addedCount} ä¸ªæ ‡ç­¾ â†’ ${categoryLabel}ï¼Œå½“å‰å…± ${tagsData.length} ä¸ª`, 'success');
        addHistory('add', `æ‰¹é‡æ·»åŠ  ${addedCount} ä¸ªæ ‡ç­¾åˆ° ${categoryLabel}`);
      } else if (addedCount > 0 && skippedCount > 0) {
        showToast(`âœ… æ·»åŠ  ${addedCount} ä¸ª â†’ ${categoryLabel}ï¼Œè·³è¿‡ ${skippedCount} ä¸ªé‡å¤`, 'success');
        addHistory('add', `æ·»åŠ  ${addedCount} ä¸ªæ ‡ç­¾åˆ° ${categoryLabel}ï¼Œè·³è¿‡ ${skippedCount} ä¸ªé‡å¤`);
      } else if (addedCount === 0 && skippedCount > 0) {
        showToast(`âš ï¸ æ ‡ç­¾å·²å­˜åœ¨ï¼š${skippedTags.join(', ')}`, 'warning');
      }
    }

    // å¿«é€Ÿæ·»åŠ 
    function quickAdd(tag, category, labelCN = '') {
      if (tagsData.some(t => t.label.toLowerCase() === tag.toLowerCase())) {
        showToast(`âš ï¸ æ ‡ç­¾å·²å­˜åœ¨ï¼š${tag}`, 'warning');
        return;
      }
      
      tagsData.push({
        id: Date.now() + Math.random(),
        label: tag,
        labelCN: labelCN,
        category: category,
        platform: null,
        source: 'manual',
        addedAt: new Date().toISOString(),
      });
      
      save();
      const categoryLabel = categoryConfig[category]?.label || category;
      showToast(`âœ… å·²æ·»åŠ ï¼š${tag} â†’ ${categoryLabel}ï¼Œå½“å‰å…± ${tagsData.length} ä¸ª`, 'success');
      addHistory('add', `æ·»åŠ æ ‡ç­¾ã€Œ${tag}ã€åˆ° ${categoryLabel}`);
    }

    // åˆ é™¤æ ‡ç­¾
    function removeTag(id) {
      const tagToRemove = tagsData.find(t => t.id === id);
      tagsData = tagsData.filter(t => t.id !== id);
      save();
      if (tagToRemove) {
        addHistory('delete', `åˆ é™¤æ ‡ç­¾ã€Œ${tagToRemove.label}ã€`);
      }
    }

    // ä¿å­˜
    function save() {
      localStorage.setItem('northAmericaTags', JSON.stringify(tagsData));
      renderTags();
      updateCount();
    }

    // æ›´æ–°è®¡æ•°
    function updateCount() {
      document.getElementById('tagCount').textContent = tagsData.length;
      
      // ç»Ÿè®¡æ¥æº
      const manualCount = tagsData.filter(t => t.source === 'manual' || !t.source).length;
      const screenshotCount = tagsData.filter(t => t.source === 'screenshot').length;
      const aiCount = tagsData.filter(t => t.source === 'ai').length;
      const batchCount = tagsData.filter(t => t.source === 'batch').length;
      
      let statsHtml = '';
      if (manualCount > 0) statsHtml += `<span>âŒ¨ï¸ æ‰‹åŠ¨ ${manualCount}</span>`;
      if (screenshotCount > 0) statsHtml += `<span>ğŸ“· æˆªå›¾ ${screenshotCount}</span>`;
      if (batchCount > 0) statsHtml += `<span>ğŸ”¥ è¾¾äººç²¾çµ ${batchCount}</span>`;
      if (aiCount > 0) statsHtml += `<span>ğŸ¤– AI ${aiCount}</span>`;
      
      document.getElementById('sourceStats').innerHTML = statsHtml || '<span>æš‚æ— æ•°æ®</span>';
    }

    // æ¸²æŸ“æ ‡ç­¾
    function renderTags() {
      const container = document.getElementById('tagContainer');
      const emptyState = document.getElementById('emptyState');
      
      if (tagsData.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      // æŒ‰åˆ†ç±»åˆ†ç»„ï¼Œæ¯ç»„å†…æŒ‰é¢‘æ¬¡é™åºæ’åˆ—
      const grouped = {};
      tagsData.forEach(tag => {
        if (!grouped[tag.category]) grouped[tag.category] = [];
        grouped[tag.category].push(tag);
      });
      
      // æ¯ä¸ªåˆ†ç±»å†…æŒ‰é¢‘æ¬¡æ’åºï¼ˆé«˜é¢‘åœ¨å‰ï¼‰
      Object.keys(grouped).forEach(category => {
        grouped[category].sort((a, b) => (b.frequency || 0) - (a.frequency || 0));
      });
      
      let html = '';
      Object.entries(grouped).forEach(([category, tags]) => {
        const config = categoryConfig[category] || categoryConfig.other;
        html += `
          <div class="mb-4">
            <h3 class="text-sm font-medium text-gray-400 mb-2">${config.label} (${tags.length})</h3>
            <div class="flex flex-wrap gap-2">
              ${tags.map(tag => {
                const isHot = tag.frequency >= 10;
                const isVeryHot = tag.frequency >= 20;
                const hotClass = isVeryHot ? 'ring-2 ring-orange-400 shadow-lg shadow-orange-500/20' : (isHot ? 'ring-1 ring-yellow-500/50' : '');
                return `
                <div class="tag-pill ${config.color} border px-3 py-1.5 rounded-full text-sm flex items-center gap-2 cursor-pointer group relative ${hotClass}" 
                     onclick="copyTag('${tag.label.replace(/'/g, "\\'")}')"
                     onmouseenter="showTagTooltip(event, ${tag.id})"
                     onmouseleave="hideTagTooltip()">
                  ${isVeryHot ? '<span class="text-orange-400">ğŸ”¥</span>' : (isHot ? '<span class="text-yellow-400">â­</span>' : '')}
                  ${tag.source === 'screenshot' ? '<span class="opacity-60">ğŸ“·</span>' : ''}
                  ${tag.source === 'ai' ? '<span class="opacity-60">ğŸ¤–</span>' : ''}
                  ${tag.source === 'batch' && !isHot && !isVeryHot ? '<span class="opacity-60">ğŸ“‹</span>' : ''}
                  <span class="font-medium">${tag.label}</span>
                  ${tag.labelCN ? `<span class="text-xs opacity-50">(${tag.labelCN})</span>` : ''}
                  ${tag.frequency ? `<span class="text-xs text-orange-400 opacity-70">${tag.frequency}æ¬¡</span>` : ''}
                  ${tag.sourceUrl ? '<span class="text-xs opacity-40">ğŸ”—</span>' : ''}
                  <button onclick="event.stopPropagation(); removeTag(${tag.id})" class="opacity-50 hover:opacity-100 ml-1">Ã—</button>
                </div>
              `}).join('')}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // å¯¼å‡º
    function exportTags() {
      const data = {
        version: '0.1',
        exportedAt: new Date().toISOString(),
        count: tagsData.length,
        tags: tagsData,
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `north-america-tags-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      addHistory('export', `å¯¼å‡º ${tagsData.length} ä¸ªæ ‡ç­¾`);
    }

    // æ¸…ç©º
    function clearAll() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ ‡ç­¾å—ï¼Ÿ')) {
        const count = tagsData.length;
        tagsData = [];
        save();
        showToast('âœ… å·²æ¸…ç©ºæ‰€æœ‰æ ‡ç­¾', 'success');
        addHistory('clear', `æ¸…ç©ºäº† ${count} ä¸ªæ ‡ç­¾`);
      }
    }
    
    // Toast é€šçŸ¥
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      
      // è®¾ç½®æ ·å¼
      if (type === 'success') {
        toast.className = 'fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl transition-all duration-300 z-50 bg-green-500/90 text-white border border-green-400';
      } else if (type === 'error') {
        toast.className = 'fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl transition-all duration-300 z-50 bg-red-500/90 text-white border border-red-400';
      } else if (type === 'warning') {
        toast.className = 'fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl transition-all duration-300 z-50 bg-yellow-500/90 text-black border border-yellow-400';
      } else {
        toast.className = 'fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-2xl transition-all duration-300 z-50 bg-gray-700 text-white border border-gray-600';
      }
      
      toastMessage.textContent = message;
      
      // æ˜¾ç¤º
      toast.style.opacity = '1';
      toast.style.transform = 'translateX(-50%) translateY(0)';
      
      // 3ç§’åéšè—
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(-1rem)';
      }, 3000);
    }
    
    // å»é‡
    function deduplicateTags() {
      const seen = new Map();
      const duplicates = [];
      
      tagsData.forEach(tag => {
        const key = tag.label.toLowerCase().trim();
        if (seen.has(key)) {
          duplicates.push(tag);
        } else {
          seen.set(key, tag);
        }
      });
      
      if (duplicates.length === 0) {
        showToast('âœ… æ²¡æœ‰å‘ç°é‡å¤æ ‡ç­¾', 'success');
        return;
      }
      
      if (confirm(`å‘ç° ${duplicates.length} ä¸ªé‡å¤æ ‡ç­¾ï¼Œæ˜¯å¦åˆ é™¤ï¼Ÿ\n\né‡å¤é¡¹ï¼š${duplicates.map(t => t.label).join(', ')}`)) {
        tagsData = Array.from(seen.values());
        save();
        showToast(`ğŸ”„ å·²åˆ é™¤ ${duplicates.length} ä¸ªé‡å¤ï¼Œå‰©ä½™ ${tagsData.length} ä¸ª`, 'success');
        addHistory('dedupe', `å»é‡åˆ é™¤ ${duplicates.length} ä¸ªé‡å¤æ ‡ç­¾`);
      }
    }
    
    // API Key å¼¹çª—
    function showApiKeyModal() {
      const currentKey = localStorage.getItem('geminiApiKey') || '';
      const maskedKey = currentKey ? currentKey.substring(0, 10) + '...' : 'ä½¿ç”¨é»˜è®¤';
      
      const newKey = prompt(`Gemini API Key è®¾ç½®\n\nå½“å‰: ${maskedKey}\n\nè¯·è¾“å…¥æ–°çš„ API Keyï¼ˆç•™ç©ºä¿æŒä¸å˜ï¼‰:`, '');
      
      if (newKey !== null && newKey.trim()) {
        localStorage.setItem('geminiApiKey', newKey.trim());
        showToast('âœ… API Key å·²ä¿å­˜', 'success');
      }
    }
    
    // å¤åˆ¶æ ‡ç­¾åˆ°å‰ªè´´æ¿
    function copyTag(label) {
      navigator.clipboard.writeText(label).then(() => {
        showToast(`ğŸ“‹ å·²å¤åˆ¶ï¼š${label}`, 'success');
      }).catch(() => {
        showToast('âŒ å¤åˆ¶å¤±è´¥', 'error');
      });
    }
    
    // æ˜¾ç¤ºæ ‡ç­¾è¯¦æƒ… Tooltip
    function showTagTooltip(event, tagId) {
      // å–æ¶ˆä»»ä½•å¾…æ‰§è¡Œçš„éšè—æ“ä½œ
      if (typeof tooltipHideTimer !== 'undefined' && tooltipHideTimer) {
        clearTimeout(tooltipHideTimer);
        tooltipHideTimer = null;
      }
      
      const tag = tagsData.find(t => t.id === tagId);
      if (!tag) return;
      
      const tooltip = document.getElementById('tagTooltip');
      const content = document.getElementById('tooltipContent');
      
      // æ ¼å¼åŒ–æ—¶é—´
      const addedDate = tag.addedAt ? new Date(tag.addedAt).toLocaleString('zh-CN') : 'æœªçŸ¥';
      
      // æ¥æºç±»å‹
      const sourceLabels = {
        manual: 'âŒ¨ï¸ æ‰‹åŠ¨è¾“å…¥',
        screenshot: 'ğŸ“· æˆªå›¾è§£æ',
        batch: 'ğŸ”¥ è¾¾äººç²¾çµæ‰¹é‡å¯¼å…¥',
        ai: 'ğŸ¤– AI è§£æ',
      };
      const sourceLabel = sourceLabels[tag.source] || 'æœªçŸ¥æ¥æº';
      
      // æ„å»ºå†…å®¹ï¼ˆå¸¦å…³é—­æŒ‰é’®ï¼‰
      let html = `
        <div class="text-white relative">
          <button onclick="hideTagTooltip()" class="absolute -top-1 -right-1 text-gray-400 hover:text-white text-lg leading-none">Ã—</button>
          <div class="font-bold text-lg mb-2 pr-4">${tag.label}</div>
          ${tag.labelCN ? `<div class="text-gray-400 text-sm mb-2">ä¸­æ–‡ï¼š${tag.labelCN}</div>` : ''}
          <div class="space-y-1 text-sm text-gray-300">
            <div>ğŸ“‚ åˆ†ç±»ï¼š${categoryConfig[tag.category]?.label || tag.category}</div>
            <div>ğŸ“± å¹³å°ï¼š${tag.platform || 'æœªæŒ‡å®š'}</div>
            <div>ğŸ“¥ æ¥æºï¼š${sourceLabel}</div>
            <div>ğŸ• æ·»åŠ æ—¶é—´ï¼š${addedDate}</div>
            ${tag.frequency ? `<div>ğŸ”¥ TikTokçƒ­åº¦ï¼š${tag.frequency} æ¬¡</div>` : ''}
          </div>
          ${tag.sourceUrl ? `
            <div class="mt-3 pt-3 border-t border-gray-700">
              <div class="text-xs text-gray-400 mb-1">ğŸ”— åŸè§†é¢‘é“¾æ¥</div>
              <a href="${tag.sourceUrl}" target="_blank" class="text-blue-400 text-xs hover:underline break-all pointer-events-auto">${tag.sourceUrl.substring(0, 50)}${tag.sourceUrl.length > 50 ? '...' : ''}</a>
            </div>
          ` : ''}
          <div class="mt-3 text-xs text-gray-500">ğŸ’¡ ç‚¹å‡»æ ‡ç­¾å¯å¤åˆ¶</div>
        </div>
      `;
      
      content.innerHTML = html;
      
      // å®šä½
      const rect = event.target.getBoundingClientRect();
      tooltip.style.display = 'block';
      tooltip.style.left = Math.min(rect.left, window.innerWidth - 320) + 'px';
      tooltip.style.top = (rect.bottom + 8) + 'px';
      
      setTimeout(() => {
        tooltip.style.opacity = '1';
      }, 10);
    }
    
    // éšè— Tooltipï¼ˆå¸¦å»¶è¿Ÿï¼Œé˜²æ­¢é—ªçƒï¼‰
    let tooltipHideTimer = null;
    
    function hideTagTooltip() {
      tooltipHideTimer = setTimeout(() => {
        const tooltip = document.getElementById('tagTooltip');
        tooltip.style.opacity = '0';
        setTimeout(() => {
          tooltip.style.display = 'none';
        }, 200);
      }, 150);  // 150ms å»¶è¿Ÿ
    }
    
    // å–æ¶ˆéšè—ï¼ˆé¼ æ ‡è¿›å…¥ tooltip æ—¶ï¼‰
    function cancelHideTooltip() {
      if (tooltipHideTimer) {
        clearTimeout(tooltipHideTimer);
        tooltipHideTimer = null;
      }
    }
    
    // åˆå§‹åŒ– tooltip äº‹ä»¶
    function initTooltipEvents() {
      const tooltip = document.getElementById('tagTooltip');
      tooltip.addEventListener('mouseenter', cancelHideTooltip);
      tooltip.addEventListener('mouseleave', hideTagTooltip);
      
      // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ tooltip
      document.addEventListener('click', (e) => {
        if (!tooltip.contains(e.target) && !e.target.closest('.tag-pill')) {
          const tooltipEl = document.getElementById('tagTooltip');
          if (tooltipEl.style.display !== 'none') {
            hideTagTooltip();
          }
        }
      });
    }

    // å¯åŠ¨
    init();
    initTooltipEvents();
  </script>
</body>
</html>
